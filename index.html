<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Genesys Cloud - Concurrency Report</title>
  <link href="https://fonts.googleapis.com/css2?family=Aptos:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --primary-color:#63AB8F;
      --secondary-color:#4A8C7D;
      --border-color:#DEE2E6;
      --light-bg:#F8F9FA;
      --card-bg:#FFFFFF;
      --text-color:#2C3E50;
      --text-light:#6C757D;
      --pill:#e9f6f0;
      --filter-bg:#f0f7f3;
      --warning:#ffc107;
      --danger:#dc3545;
      --success:#28a745;
      --info:#17a2b8;
      --peak-color:#dc3545;
      --high-color:#ffc107;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body{
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
      margin:20px;
      background:var(--light-bg);
      color:var(--text-color);
      line-height:1.6;
    }
    .container{ max-width:1600px; margin:0 auto; }
    header{
      background:var(--card-bg); border-radius:12px; padding:28px 36px; margin-bottom:28px;
      box-shadow:0 2px 8px rgba(0,0,0,.08); border-left:5px solid var(--primary-color);
      border:1px solid var(--border-color); display:flex; justify-content:space-between;
      align-items:center; flex-wrap:wrap;
    }
    .brand-text {
      display: flex;
      flex-direction: column;
    }
    .brand-main {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    h1{
      color:var(--text-color); font-size:32px; font-weight:600; display:flex;
      align-items:center; gap:12px; margin:0;
    }
    .subtitle{ 
      color:var(--text-light); font-size:17px; margin-top:4px; 
    }
    .main-grid{ display:grid; grid-template-columns:400px 1fr; gap:32px; }
    @media(max-width:1200px){ .main-grid{grid-template-columns:1fr;} }
    .card{
      background:var(--card-bg); border:1px solid var(--border-color); border-radius:14px;
      padding:28px; margin-bottom:24px; box-shadow:0 2px 8px rgba(0,0,0,.05);
    }
    .card h2{
      color:var(--primary-color); margin-bottom:24px; font-size:22px; padding-bottom:16px;
      border-bottom:2px solid var(--light-bg); display:flex; align-items:center; gap:12px; font-weight:600;
    }
    .form-group{margin-bottom:24px;}
    label{ display:block; font-weight:600; margin-bottom:8px; font-size:14px; }
    select,input,button{
      padding:12px; border:1px solid var(--border-color); border-radius:8px; font-size:15px;
      width:100%; font-family:inherit;
    }
    button{
      background:var(--primary-color); color:#fff; font-weight:600; cursor:pointer;
      transition:background .2s; border:none; display:inline-flex; align-items:center;
      justify-content:center; gap:10px; font-size:15px;
    }
    button:hover{background:var(--secondary-color);}
    button:disabled{background:var(--text-light);cursor:not-allowed;}
    .btn-block{width:100%;padding:14px;}
    .btn-success{background:var(--success);}
    .btn-success:hover{background:#218838;}
    .btn-danger{background:var(--danger);}
    .btn-danger:hover{background:#bd2130;}
    .date-range-simple{
      display:flex; flex-direction:column; gap:16px; margin-bottom:20px;
    }
    .date-field-simple{ position:relative; }
    .date-field-simple label{
      display:block; font-weight:600; margin-bottom:8px; font-size:14px;
    }
    .date-field-simple input[type="date"]{
      padding:14px; border:1px solid var(--border-color); border-radius:8px;
      background:var(--card-bg); font-size:15px; width:100%; transition:all 0.3s;
      color:var(--text-color);
    }
    .date-field-simple input[type="date"]:focus{
      outline:none; border-color:var(--primary-color);
      box-shadow:0 0 0 3px rgba(99,171,143,0.1);
    }
    @media (min-width: 768px){
      .date-range-simple{ flex-direction:row; gap:16px; }
      .date-field-simple{ flex:1; }
    }
    .granularity-info{
      background:var(--pill);
      padding:16px;
      border-radius:8px;
      text-align:center;
      margin:20px 0;
      font-weight:600;
      color:var(--primary-color);
      border:1px solid var(--border-color);
    }
    .stats-grid{
      display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-bottom:24px;
    }
    .stat-card{
      background:var(--pill); border-radius:14px; padding:24px; border:1px solid var(--border-color);
      text-align:center; transition:all 0.3s;
    }
    .stat-card:hover{
      transform:translateY(-2px); box-shadow:0 8px 16px rgba(0,0,0,0.1);
      border-color:var(--primary-color);
    }
    .stat-value{
      font-size:38px; font-weight:700; color:var(--primary-color); margin:12px 0;
    }
    .stat-label{
      font-size:15px; color:var(--text-light); text-transform:uppercase; letter-spacing:1px; font-weight:600;
    }
    .peak-stat{ background:rgba(220,53,69,0.1); border-color:rgba(220,53,69,0.3); }
    .peak-stat .stat-value{color:var(--danger);}
    .chart-container{
      background:var(--card-bg); border-radius:12px; padding:20px; margin-top:20px;
      height:400px; position:relative;
    }
    .table-container{
      overflow-x:auto; margin-top:24px; border-radius:10px; border:1px solid var(--border-color);
      background:var(--card-bg); max-height:500px; overflow-y:auto;
    }
    table{width:100%;border-collapse:collapse;}
    th{
      background:var(--primary-color); color:white; font-weight:600; position:sticky; top:0;
      padding:16px; text-align:left; font-size:14px;
    }
    td{padding:14px 16px;border-bottom:1px solid var(--border-color);font-size:14px;}
    tr:hover{background:var(--pill);}
    .peak-badge{
      display:inline-block; padding:6px 14px; border-radius:20px; font-size:13px; font-weight:600;
      background:rgba(220,53,69,0.15); color:var(--danger); border:1px solid rgba(220,53,69,0.3);
    }
    .high-badge{
      background:rgba(255,193,7,0.15); color:#d39e00; border:1px solid rgba(255,193,7,0.3);
    }
    .status-container{
      position:fixed; top:20px; right:20px; z-index:1000; max-width:400px;
    }
    .status-message{
      background:white; padding:16px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15);
      border-left:4px solid var(--primary-color); margin-bottom:10px; animation:slideIn 0.3s;
      display:flex; align-items:center; gap:12px;
    }
    @keyframes slideIn{ from{transform:translateX(100%);opacity:0;} to{transform:translateX(0);opacity:1;} }
    .loading-overlay{
      position:fixed; top:0;left:0;right:0;bottom:0; background:rgba(255,255,255,0.95);
      display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:9999;
      display:none;
    }
    .loading-overlay.active{display:flex;}
    .spinner{
      width:60px;height:60px; border:5px solid #f3f3f3; border-top:5px solid var(--primary-color);
      border-radius:50%; animation:spin 1s linear infinite; margin-bottom:20px;
    }
    @keyframes spin{to{transform:rotate(360deg);}}
    .progress-bar{
      width:100%; max-width:500px; height:10px; background:var(--light-bg);
      border-radius:5px; margin-top:20px; overflow:hidden;
    }
    .progress-fill{
      height:100%; background:linear-gradient(90deg,var(--primary-color),var(--secondary-color));
      width:0%; transition:width 0.3s;
    }
    .peak-time-grid{
      display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:20px; margin-bottom:24px;
    }
    .peak-card{
      background:white; border-radius:14px; padding:24px; border:1px solid var(--border-color);
      box-shadow:0 2px 8px rgba(0,0,0,.05);
    }
    .peak-time{ font-size:28px; font-weight:700; color:var(--danger); margin:12px 0; }
    .connection-status{
      display:flex; align-items:center; gap:12px; background:var(--light-bg);
      padding:12px 24px; border-radius:30px;
    }
    .status-indicator{ width:14px; height:14px; border-radius:50%; background:var(--text-light); }
    .connected .status-indicator{background:var(--success);}
    .footer{ margin-top:30px; padding:20px; text-align:center; color:var(--text-light); font-size:13px; }
    .info-box{
      background:rgba(99,171,143,0.05); border-radius:8px; padding:16px; margin-top:16px;
      font-size:13px; color:var(--text-light);
    }
    .brand { display: flex; align-items: center; gap: 15px; }
    .brand-logo { height: 40px; object-fit: contain; }
    .divider { border: none; height: 1px; background: var(--border-color); margin: 0; }
    .region-badge {
      background: var(--info);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-left: 12px;
      display: inline-block;
    }
    .daily-note {
      background: var(--primary-color);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      margin-left: 15px;
    }
  </style>
</head>
<body>
  <div id="app-content" style="width:100%;height:100%;flex:1;display:flex;flex-direction:column;">
    <header>
      <div class="brand">
        <img src="https://raw.githubusercontent.com/gmcglynn88/TimeoffApp/main/YourTime%20Logo_WEM_White%20Reversed.png" alt="Your Time" class="brand-logo">
        <div class="brand-text">
          <div class="brand-main">
            <h1>üìä Concurrency Report</h1>
          </div>
          <div class="subtitle">Genesys Cloud - London Region (apps.euw2.pure.cloud)</div>
        </div>
      </div>
      <div class="connection-status" id="connectionStatus">
        <span class="status-indicator" id="statusIndicator"></span>
        <span id="statusText">Initialising...</span>
      </div>
    </header>
    <hr class="divider">

    <div class="main-content">
      <div class="container" style="width:100%;padding:20px;">
        <div class="main-grid">
          <!-- Left Column - Controls -->
          <div class="left-column">
            <div class="card">
              <h2>üìÖ Analysis Period</h2>
              <div class="date-range-simple">
                <div class="date-field-simple">
                  <label for="dateFrom">From Date</label>
                  <input type="date" id="dateFrom" required>
                </div>
                <div class="date-field-simple">
                  <label for="dateTo">To Date</label>
                  <input type="date" id="dateTo" required>
                </div>
              </div>
              <div id="dateRangeInfo" style="font-size:13px;color:var(--text-light);text-align:center;margin-top:12px;padding:10px;background:var(--pill);border-radius:6px;">
                Last 7 days selected
              </div>
            </div>

            <div class="card">
              <h2>‚è±Ô∏è Analysis Type</h2>
              <div class="granularity-info">
                <i class="fas fa-calendar-day" style="margin-right:8px;"></i>
                Daily Aggregation Only
              </div>
              <div style="margin-top:16px;font-size:14px;color:var(--text-light);padding:12px;background:var(--light-bg);border-radius:8px;">
                <strong>Note:</strong> Analysis is performed at daily granularity. Each day shows the maximum concurrent logged-in users during that day, with a 4-hour session cap applied to prevent overnight counting.
              </div>
              
              <div style="margin-top:24px;">
                <label for="thresholdConcurrency">Daily Concurrency Alert Threshold</label>
                <input type="number" id="thresholdConcurrency" value="20" min="1" max="1000">
                <div style="font-size:13px;color:var(--text-light);margin-top:6px;">
                  Highlight days exceeding this concurrent logged-in user count
                </div>
              </div>
            </div>

            <div class="card">
              <h2>üöÄ Actions</h2>
              <button id="btnFetchUsers" class="btn-block" style="margin-bottom:16px;" disabled>
                üë• 1. Fetch Users
              </button>
              <button id="btnFetchConcurrency" class="btn-success btn-block" style="margin-bottom:16px;" disabled>
                üìä 2. Analyse Daily Concurrency
              </button>
              <button id="btnExport" class="btn-block" style="margin-bottom:16px;background:var(--text-light);" disabled>
                üì• Export Daily Report
              </button>
              <button id="btnReset" class="btn-danger btn-block">
                üîÑ Reset Session
              </button>
              
              <!-- Manual Authentication Button -->
              <button id="btnManualAuth" class="btn-block" style="margin-bottom:16px;background:var(--info);">
                üîê Re-authenticate
              </button>
              
              <div class="info-box" style="margin-top:24px;">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                  <span style="background:var(--primary-color);color:white;padding:2px 12px;border-radius:20px;font-size:12px;">OAuth Settings</span>
                </div>
                <div style="font-size:12px;">
                  <strong>Client ID:</strong>e0d44bdf-d2e1-438f-9743-e85c25823b26<br>
                  <strong>Redirect URI:</strong> <span id="currentRedirectUri"></span><br>
                  <strong>Environment:</strong> login.euw2.pure.cloud
                </div>
              </div>

              <div class="info-box" style="margin-top:24px;">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                  <span style="background:var(--primary-color);color:white;padding:2px 12px;border-radius:20px;font-size:12px;">London Region - Daily Analysis</span>
                </div>
                <ul style="list-style-type:none;padding-left:0;">
                  <li style="margin-bottom:8px;">‚úì Fetches all active users</li>
                  <li style="margin-bottom:8px;">‚úì Queries presence history via User Details API</li>
                  <li style="margin-bottom:8px;">‚úì Splits long date ranges into 7-day windows</li>
                  <li style="margin-bottom:8px;">‚úì **Daily aggregation** - shows peak concurrency per day</li>
                  <li style="margin-bottom:8px;">‚úì **4-hour session cap** prevents overnight counting</li>
                  <li style="margin-bottom:8px;">‚úì **24-hour intervals** for clear daily trend analysis</li>
                  <li>‚úì Perfect for capacity planning and daily trend analysis</li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Right Column - Results -->
          <div class="right-column">
            <!-- Key Stats -->
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-label">Total Users</div>
                <div class="stat-value" id="statTotalUsers">0</div>
                <div style="font-size:12px;color:var(--text-light);">Active licensed users</div>
              </div>
              <div class="stat-card peak-stat">
                <div class="stat-label">Peak Daily Concurrency</div>
                <div class="stat-value" id="statPeakConcurrency">0</div>
                <div style="font-size:12px;color:var(--text-light);">Max concurrent logged-in (any day)</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Avg Daily Concurrency</div>
                <div class="stat-value" id="statAvgConcurrency">0</div>
                <div style="font-size:12px;color:var(--text-light);">Period average per day</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Total Days</div>
                <div class="stat-value" id="statTotalIntervals">0</div>
                <div style="font-size:12px;color:var(--text-light);">Days analysed</div>
              </div>
            </div>

            <!-- Peak Times Cards -->
            <div class="peak-time-grid">
              <div class="peak-card">
                <div style="display:flex;align-items:center;gap:8px;">
                  <span style="font-size:24px;">üèÜ</span>
                  <h3 style="margin:0;font-size:18px;color:var(--text-color);">Peak Day</h3>
                </div>
                <div class="peak-time" id="peakTimeOverall">--/--/----</div>
                <div style="color:var(--text-light);" id="peakConcurrencyOverall">0 concurrent users</div>
              </div>
              <div class="peak-card">
                <div style="display:flex;align-items:center;gap:8px;">
                  <span style="font-size:24px;">üìä</span>
                  <h3 style="margin:0;font-size:18px;color:var(--text-color);">Total Days</h3>
                </div>
                <div class="peak-time" id="peakDay">0</div>
                <div style="color:var(--text-light);" id="peakDayConcurrency">days in range</div>
              </div>
              <div class="peak-card">
                <div style="display:flex;align-items:center;gap:8px;">
                  <span style="font-size:24px;">‚ö†Ô∏è</span>
                  <h3 style="margin:0;font-size:18px;color:var(--text-color);">Days Above Threshold</h3>
                </div>
                <div class="peak-time" id="peakHour">0</div>
                <div style="color:var(--text-light);" id="peakHourConcurrency">days exceed alert</div>
              </div>
            </div>

            <!-- Concurrency Chart -->
            <div class="card">
              <h2>üìä Daily Concurrency Trend</h2>
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <span style="font-weight:600;color:var(--primary-color);background:var(--pill);padding:8px 16px;border-radius:20px;">
                  <i class="fas fa-calendar-day"></i> Daily intervals
                </span>
                <span style="background:rgba(220,53,69,0.1);padding:8px 16px;border-radius:20px;font-size:13px;font-weight:600;">
                  Alert threshold: <span id="thresholdValue" style="color:var(--danger);">20</span> users
                </span>
              </div>
              <div class="chart-container">
                <canvas id="concurrencyChart"></canvas>
              </div>
            </div>

            <!-- Peak Days Table -->
            <div class="card">
              <h2>‚ö†Ô∏è Peak Days (Exceeding Threshold)</h2>
              <div class="table-container">
                <table id="peakTable">
                  <thead>
                    <tr>
                      <th>Date (UTC)</th>
                      <th>Peak Concurrent Users</th>
                      <th>% of Peak Day</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="peakTableBody">
                    <tr>
                      <td colspan="4" style="text-align:center;padding:48px;color:var(--text-light);">
                        No data yet. Fetch users and run daily concurrency analysis.
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- All Days Data -->
            <div class="card">
              <h2>üìã All Days</h2>
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <input type="text" id="searchInterval" placeholder="üîç Search date..." style="max-width:300px;padding:12px;">
                <span style="font-size:13px;color:var(--text-light);background:var(--pill);padding:8px 16px;border-radius:20px;">
                  Showing <span id="visibleIntervals">0</span>/<span id="totalIntervals">0</span> days
                </span>
              </div>
              <div class="table-container" style="max-height:400px;">
                <table id="intervalsTable">
                  <thead>
                    <tr>
                      <th>Date (UTC)</th>
                      <th>Peak Concurrent Users</th>
                      <th>Change from Previous Day</th>
                    </tr>
                  </thead>
                  <tbody id="intervalsTableBody">
                    <tr>
                      <td colspan="3" style="text-align:center;padding:48px;color:var(--text-light);">
                        No data available.
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText" style="font-size:20px;font-weight:600;margin-bottom:12px;">Loading...</div>
    <div id="loadingSubtext" style="font-size:15px;color:var(--text-light);text-align:center;max-width:500px;"></div>
    <div class="progress-bar">
      <div class="progress-fill" id="loadingProgressFill"></div>
    </div>
  </div>

  <div class="status-container" id="statusContainer"></div>

  <script>
    // ==================== LONDON REGION CONFIGURATION ====================
    const CLIENT_ID = 'e0d44bdf-d2e1-438f-9743-e85c25823b26';
    const REDIRECT_URI = window.location.href.split('#')[0];
    
    const ENVIRONMENTS = {
      'eu-west-2': { 
        name: 'London (EU West 2)', 
        api: 'https://api.euw2.pure.cloud', 
        login: 'https://login.euw2.pure.cloud' 
      }
    };

    const STORAGE_KEYS = {
      ENVIRONMENT: 'gc_concurrency_london_env',
      TOKEN: 'gc_concurrency_london_token',
      TOKEN_EXPIRY: 'gc_concurrency_london_expiry',
      DATE_FROM: 'gc_concurrency_london_date_from',
      DATE_TO: 'gc_concurrency_london_date_to',
      THRESHOLD: 'gc_concurrency_london_threshold'
    };

    // ==================== APP STATE ====================
    let appState = {
      isConnected: false,
      token: null,
      tokenExpiry: null,
      environment: ENVIRONMENTS['eu-west-2'],
      users: [],
      concurrencyData: [],
      stats: {
        totalUsers: 0,
        peakConcurrency: 0,
        avgConcurrency: 0,
        totalIntervals: 0,
        peakInterval: null
      },
      threshold: 20,
      chart: null
    };

    // ==================== DOM ELEMENTS ====================
    const el = {
      mainContent: document.getElementById('app-content'),
      statusIndicator: document.getElementById('statusIndicator'),
      statusText: document.getElementById('statusText'),
      dateFrom: document.getElementById('dateFrom'),
      dateTo: document.getElementById('dateTo'),
      dateRangeInfo: document.getElementById('dateRangeInfo'),
      thresholdConcurrency: document.getElementById('thresholdConcurrency'),
      statTotalUsers: document.getElementById('statTotalUsers'),
      statPeakConcurrency: document.getElementById('statPeakConcurrency'),
      statAvgConcurrency: document.getElementById('statAvgConcurrency'),
      statTotalIntervals: document.getElementById('statTotalIntervals'),
      peakTimeOverall: document.getElementById('peakTimeOverall'),
      peakConcurrencyOverall: document.getElementById('peakConcurrencyOverall'),
      peakDay: document.getElementById('peakDay'),
      peakDayConcurrency: document.getElementById('peakDayConcurrency'),
      peakHour: document.getElementById('peakHour'),
      peakHourConcurrency: document.getElementById('peakHourConcurrency'),
      thresholdValue: document.getElementById('thresholdValue'),
      peakTableBody: document.getElementById('peakTableBody'),
      intervalsTableBody: document.getElementById('intervalsTableBody'),
      btnFetchUsers: document.getElementById('btnFetchUsers'),
      btnFetchConcurrency: document.getElementById('btnFetchConcurrency'),
      btnExport: document.getElementById('btnExport'),
      btnReset: document.getElementById('btnReset'),
      btnManualAuth: document.getElementById('btnManualAuth'),
      searchInterval: document.getElementById('searchInterval'),
      visibleIntervals: document.getElementById('visibleIntervals'),
      totalIntervals: document.getElementById('totalIntervals'),
      loadingOverlay: document.getElementById('loadingOverlay'),
      loadingText: document.getElementById('loadingText'),
      loadingSubtext: document.getElementById('loadingSubtext'),
      loadingProgressFill: document.getElementById('loadingProgressFill'),
      statusContainer: document.getElementById('statusContainer'),
      concurrencyChart: document.getElementById('concurrencyChart'),
      currentRedirectUri: document.getElementById('currentRedirectUri')
    };

    if (el.currentRedirectUri) {
      el.currentRedirectUri.textContent = REDIRECT_URI;
    }

    // ==================== AUTHENTICATION ====================
    function parseTokenFromHash() {
      const hash = window.location.hash.replace(/^#/, '');
      if (!hash) return {};
      const params = new URLSearchParams(hash);
      return {
        token: params.get('access_token'),
        error: params.get('error'),
        errorDescription: params.get('error_description'),
        expiresIn: params.get('expires_in')
      };
    }

    function saveCredentials(token, expiresIn) {
      try {
        const tokenExpiry = Date.now() + (parseInt(expiresIn, 10) * 1000);
        appState.token = token;
        appState.tokenExpiry = tokenExpiry;
        appState.isConnected = true;
        appState.environment = ENVIRONMENTS['eu-west-2'];
        localStorage.setItem(STORAGE_KEYS.TOKEN, token);
        localStorage.setItem(STORAGE_KEYS.TOKEN_EXPIRY, tokenExpiry.toString());
        localStorage.setItem(STORAGE_KEYS.ENVIRONMENT, 'eu-west-2');
        return true;
      } catch (e) {
        console.error('Failed to save credentials:', e);
        return false;
      }
    }

    function loadStoredCredentials() {
      try {
        const token = localStorage.getItem(STORAGE_KEYS.TOKEN);
        const tokenExpiry = localStorage.getItem(STORAGE_KEYS.TOKEN_EXPIRY);
        const environment = localStorage.getItem(STORAGE_KEYS.ENVIRONMENT);
        if (token && tokenExpiry && environment) {
          const expiry = parseInt(tokenExpiry, 10);
          if (Date.now() < expiry) {
            appState.token = token;
            appState.tokenExpiry = expiry;
            appState.isConnected = true;
            appState.environment = ENVIRONMENTS['eu-west-2'];
            return true;
          } else {
            localStorage.removeItem(STORAGE_KEYS.TOKEN);
            localStorage.removeItem(STORAGE_KEYS.TOKEN_EXPIRY);
            localStorage.removeItem(STORAGE_KEYS.ENVIRONMENT);
          }
        }
      } catch (e) {
        console.warn('Failed to load stored credentials:', e);
      }
      return false;
    }

    function clearCredentials() {
      try {
        localStorage.removeItem(STORAGE_KEYS.TOKEN);
        localStorage.removeItem(STORAGE_KEYS.TOKEN_EXPIRY);
        localStorage.removeItem(STORAGE_KEYS.ENVIRONMENT);
        localStorage.removeItem(STORAGE_KEYS.DATE_FROM);
        localStorage.removeItem(STORAGE_KEYS.DATE_TO);
        localStorage.removeItem(STORAGE_KEYS.THRESHOLD);
        appState.token = null;
        appState.tokenExpiry = null;
        appState.isConnected = false;
        appState.users = [];
        appState.concurrencyData = [];
      } catch (e) {
        console.error('Failed to clear credentials:', e);
      }
    }

    function authUrl() {
      const baseUrl = ENVIRONMENTS['eu-west-2'].login;
      const clientId = encodeURIComponent(CLIENT_ID);
      const redirectUri = encodeURIComponent(REDIRECT_URI);
      return `${baseUrl}/oauth/authorize?client_id=${clientId}&response_type=token&redirect_uri=${redirectUri}`;
    }

    function initAuth() {
      console.log("Initializing London region authentication...");
      const { token, error, errorDescription, expiresIn } = parseTokenFromHash();
      
      if (window.location.hash) {
        history.replaceState(null, '', window.location.pathname + window.location.search);
      }
      
      if (token) {
        saveCredentials(token, expiresIn || '3600');
        updateConnectionStatus(true);
        showStatusMessage('‚úÖ Authentication successful - London Region', 'success');
        return;
      }
      
      if (error) {
        showStatusMessage(`‚ùå Authentication failed: ${errorDescription || error}`, 'error');
      }
      
      if (loadStoredCredentials()) {
        updateConnectionStatus(true);
        showStatusMessage('‚úÖ Authenticated with stored credentials - London Region', 'success');
        return;
      }
      
      if (!token && !error && !loadStoredCredentials()) {
        window.location.href = authUrl();
      }
    }

    function manualAuth() {
      clearCredentials();
      window.location.href = authUrl();
    }

    // ==================== UTILITIES ====================
    function showStatusMessage(message, type = 'info') {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'status-message';
      const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warn' ? '‚ö†Ô∏è' : 'üí°';
      const color = type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : type === 'warn' ? 'var(--warning)' : 'var(--info)';
      msgDiv.style.borderLeftColor = color;
      msgDiv.innerHTML = `<span style="font-size:20px;">${icon}</span><div><div style="font-weight:600;">${message}</div><div style="font-size:12px;color:var(--text-light);">${new Date().toLocaleTimeString()}</div></div>`;
      document.getElementById('statusContainer').appendChild(msgDiv);
      setTimeout(() => { if (msgDiv.parentNode) { msgDiv.style.opacity = '0'; msgDiv.style.transform = 'translateX(100%)'; setTimeout(() => msgDiv.remove(), 300); } }, 5000);
    }

    function setLoading(show, text = '', subtext = '') {
      if (show) {
        el.loadingText.textContent = text;
        el.loadingSubtext.textContent = subtext;
        el.loadingOverlay.classList.add('active');
      } else {
        el.loadingOverlay.classList.remove('active');
      }
    }

    function updateLoadingProgress(percent) {
      el.loadingProgressFill.style.width = `${percent}%`;
    }

    function updateConnectionStatus(connected) {
      appState.isConnected = connected;
      if (el.statusIndicator) {
        el.statusIndicator.style.background = connected ? 'var(--success)' : 'var(--danger)';
      }
      if (el.statusText) {
        el.statusText.textContent = connected ? 'Connected to London (euw2)' : 'Not Connected';
        el.statusText.style.color = connected ? 'var(--success)' : 'var(--danger)';
      }
      if (el.btnFetchUsers) {
        el.btnFetchUsers.disabled = !connected;
      }
    }

    function formatDateOnly(intervalStr) {
      try {
        const start = new Date(intervalStr.split('/')[0]);
        return start.toLocaleDateString('en-GB', { 
          day: '2-digit', 
          month: 'short', 
          year: 'numeric', 
          timeZone: 'UTC' 
        });
      } catch (e) {
        return intervalStr;
      }
    }

    function formatDateFromInterval(intervalStr) {
      try {
        const start = new Date(intervalStr.split('/')[0]);
        return start.toLocaleDateString('en-GB', { 
          day: '2-digit', 
          month: 'short', 
          year: 'numeric', 
          timeZone: 'UTC' 
        });
      } catch (e) {
        return '--/--/----';
      }
    }

    function getLast7Days() {
      const today = new Date();
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(today.getDate() - 7);
      return { from: sevenDaysAgo.toISOString().split('T')[0], to: today.toISOString().split('T')[0] };
    }

    function updateDateRangeInfo() {
      const fromDate = el.dateFrom.value;
      const toDate = el.dateTo.value;
      if (fromDate && toDate) {
        const start = new Date(fromDate);
        const end = new Date(toDate);
        const diffTime = Math.abs(end - start);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        el.dateRangeInfo.innerHTML = `<strong>Selected:</strong> ${formatDateFromInterval(fromDate+'T00:00:00.000Z/')} to ${formatDateFromInterval(toDate+'T00:00:00.000Z/')} (${diffDays} days)`;
        if (diffDays > 7) {
          el.dateRangeInfo.innerHTML += '<br><span style="color:var(--warning);">‚ö†Ô∏è Range >7 days - will be split into 7-day windows</span>';
        }
      }
    }

    // ==================== API CALLS ====================
    async function apiCall(path, options = {}) {
      if (!appState.isConnected || !appState.token) {
        throw new Error('Not authenticated');
      }
      if (Date.now() > appState.tokenExpiry) {
        clearCredentials();
        throw new Error('Token expired. Please reconnect.');
      }
      const url = `${appState.environment.api}${path}`;
      const response = await fetch(url, {
        ...options,
        headers: {
          'Authorization': `Bearer ${appState.token}`,
          'Content-Type': 'application/json',
          ...options.headers
        }
      });
      if (response.status === 401) {
        clearCredentials();
        throw new Error('Authentication expired. Please reconnect.');
      }
      if (response.status === 429) {
        const retryAfter = response.headers.get('Retry-After') || 5;
        await new Promise(resolve => setTimeout(resolve, retryAfter * 1000));
        return apiCall(path, options);
      }
      if (!response.ok) {
        throw new Error(`API Error: ${response.status} ${response.statusText}`);
      }
      return response.json();
    }

    // ==================== FETCH USERS ====================
    async function fetchUsers() {
      if (!appState.isConnected) {
        showStatusMessage('Please connect first', 'error');
        return;
      }
      setLoading(true, 'Fetching Users', 'Retrieving all active users from Genesys Cloud London...');
      updateLoadingProgress(10);
      try {
        let allUsers = [];
        let page = 1;
        const pageSize = 100;
        while (true) {
          updateLoadingProgress(10 + (page * 5));
          const response = await apiCall(`/api/v2/users?pageSize=${pageSize}&pageNumber=${page}&state=active`);
          allUsers = allUsers.concat(response.entities || []);
          if (!response.nextUri || response.entities.length < pageSize) { break; }
          page++;
          await new Promise(resolve => setTimeout(resolve, 200));
        }
        appState.users = allUsers;
        appState.stats.totalUsers = allUsers.length;
        el.statTotalUsers.textContent = allUsers.length;
        showStatusMessage(`‚úÖ Fetched ${allUsers.length} active users from London`, 'success');
        el.btnFetchConcurrency.disabled = false;
        updateLoadingProgress(100);
        setTimeout(() => setLoading(false), 500);
      } catch (error) {
        setLoading(false);
        showStatusMessage(`‚ùå Failed to fetch users: ${error.message}`, 'error');
      }
    }

    // ==================== INTERVAL OVERLAP WITH DURATION ====================
    function calculateOverlapDuration(interval1, interval2) {
      try {
        const [start1, end1] = interval1.split('/').map(d => new Date(d));
        const [start2, end2] = interval2.split('/').map(d => new Date(d));
        
        const overlapStart = new Date(Math.max(start1, start2));
        const overlapEnd = new Date(Math.min(end1, end2));
        
        if (overlapStart < overlapEnd) {
          return (overlapEnd - overlapStart) / (1000 * 60);
        }
        return 0;
      } catch (e) {
        return 0;
      }
    }

    // ==================== GENERATE DAILY INTERVALS ====================
    function generateDailyIntervals(dateFrom, dateTo) {
      const intervals = [];
      const start = new Date(`${dateFrom}T00:00:00.000Z`);
      const end = new Date(`${dateTo}T23:59:59.999Z`);
      let current = new Date(start);
      
      while (current <= end) {
        const dayStart = new Date(current);
        const dayEnd = new Date(current);
        dayEnd.setUTCHours(23, 59, 59, 999);
        
        const intervalStr = `${dayStart.toISOString()}/${dayEnd.toISOString()}`;
        intervals.push(intervalStr);
        
        current.setUTCDate(current.getUTCDate() + 1);
      }
      return intervals;
    }

    // ==================== FETCH DAILY CONCURRENCY ====================
    async function fetchConcurrency() {
      if (!appState.users.length) {
        showStatusMessage('Please fetch users first', 'error');
        return;
      }

      setLoading(true, 'Analysing Daily Concurrency', 'Splitting date range into 7-day windows...');
      updateLoadingProgress(5);

      try {
        const dateFrom = el.dateFrom.value;
        const dateTo = el.dateTo.value;
        
        if (!dateFrom || !dateTo) {
          throw new Error('Please select a date range');
        }

        const userIds = appState.users.map(u => u.id);
        
        // Split the overall range into 7-day chunks
        const startDate = new Date(`${dateFrom}T00:00:00.000Z`);
        const endDate = new Date(`${dateTo}T23:59:59.999Z`);
        const intervals7Day = [];
        
        let currentStart = new Date(startDate);
        while (currentStart < endDate) {
          let currentEnd = new Date(currentStart);
          currentEnd.setDate(currentEnd.getDate() + 6);
          if (currentEnd > endDate) currentEnd = new Date(endDate);
          
          const intervalStr = `${currentStart.toISOString().split('.')[0]}Z/${currentEnd.toISOString().split('.')[0]}Z`;
          intervals7Day.push(intervalStr);
          
          currentStart = new Date(currentEnd);
          currentStart.setDate(currentStart.getDate() + 1);
        }

        // Generate daily intervals for the whole period
        const dailyIntervals = generateDailyIntervals(dateFrom, dateTo);
        
        // Map to store presence minutes per user per day
        const concurrencyMinutesMap = new Map();
        dailyIntervals.forEach(interval => {
          concurrencyMinutesMap.set(interval, new Map());
        });

        updateLoadingProgress(10);
        showStatusMessage(`üìÖ Split into ${intervals7Day.length} x 7-day windows for daily analysis`, 'info');

        // Process each 7-day window
        for (let w = 0; w < intervals7Day.length; w++) {
          const windowInterval = intervals7Day[w];
          
          for (let i = 0; i < userIds.length; i += 25) {
            const batch = userIds.slice(i, i + 25);
            
            let pageNumber = 1;
            let hasMorePages = true;

            while (hasMorePages) {
              el.loadingSubtext.innerHTML = `Window ${w+1}/${intervals7Day.length} | Batch ${i}-${Math.min(i+25, userIds.length)} | Page ${pageNumber}`;
              
              const queryBody = {
                interval: windowInterval,
                userFilters: [{
                  type: 'or',
                  predicates: batch.map(userId => ({
                    type: 'dimension',
                    dimension: 'userId',
                    value: userId
                  }))
                }],
                paging: {
                  pageSize: 100,
                  pageNumber: pageNumber
                }
              };

              try {
                const response = await apiCall('/api/v2/analytics/users/details/query', {
                  method: 'POST',
                  body: JSON.stringify(queryBody)
                });

                if (response.userDetails) {
                  response.userDetails.forEach(userDetail => {
                    const userId = userDetail.userId;
                    if (userDetail.primaryPresence) {
                      userDetail.primaryPresence.forEach(presenceEvent => {
                        // ONLY count if presence is NOT Offline
                        if (presenceEvent.systemPresence !== 'Offline' && presenceEvent.systemPresence !== null) {
                          
                          // Apply 4-hour session cap to prevent overnight counting
                          let presenceEnd = presenceEvent.endTime;
                          
                          if (!presenceEnd) {
                            const start = new Date(presenceEvent.startTime);
                            const fourHoursLater = new Date(start.getTime() + (4 * 60 * 60 * 1000));
                            presenceEnd = fourHoursLater.toISOString();
                          }
                          
                          const presenceInterval = `${presenceEvent.startTime}/${presenceEnd}`;
                          
                          // Check overlap with each day in the range
                          dailyIntervals.forEach(dayInterval => {
                            const overlapMinutes = calculateOverlapDuration(presenceInterval, dayInterval);
                            if (overlapMinutes > 0) {
                              const userMinutesMap = concurrencyMinutesMap.get(dayInterval);
                              const currentMinutes = userMinutesMap.get(userId) || 0;
                              userMinutesMap.set(userId, currentMinutes + overlapMinutes);
                            }
                          });
                        }
                      });
                    }
                  });
                }

                // Check if there are more pages
                const totalHits = response.totalHits || 0;
                const fetchedSoFar = pageNumber * 100;

                if (fetchedSoFar >= totalHits || !response.userDetails || response.userDetails.length < 100) {
                  hasMorePages = false;
                } else {
                  pageNumber++;
                  // Rate limit protection between pages
                  await new Promise(resolve => setTimeout(resolve, 300));
                }

                const overallProgress = 10 + ((w / intervals7Day.length) * 80) + ((i / userIds.length) * (80 / intervals7Day.length));
                updateLoadingProgress(overallProgress);

              } catch (batchError) {
                console.warn(`Window ${w+1}, batch ${i}-${i+25}, page ${pageNumber} failed:`, batchError);
                showStatusMessage(`‚ö†Ô∏è Window ${w+1} partial failure`, 'warn');
                // Continue with next page or batch
                hasMorePages = false;
              }
            }
            
            // Rate limit protection between batches
            await new Promise(resolve => setTimeout(resolve, 300));
          }
        }

        updateLoadingProgress(95);

        // Convert minutes map to concurrency counts - count users with >0 minutes in the day
        const concurrencyData = [];
        let peakConcurrency = 0;
        let totalConcurrency = 0;
        let daysAboveThreshold = 0;
        
        concurrencyMinutesMap.forEach((userMinutesMap, interval) => {
          // Count users with any logged-in time during the day
          const concurrent = Array.from(userMinutesMap.values()).filter(minutes => minutes > 0).length;
          
          concurrencyData.push({
            interval: interval,
            concurrent: concurrent,
            date: new Date(interval.split('/')[0])
          });
          
          totalConcurrency += concurrent;
          if (concurrent > peakConcurrency) peakConcurrency = concurrent;
          if (concurrent > appState.threshold) daysAboveThreshold++;
        });

        concurrencyData.sort((a, b) => a.date - b.date);
        
        appState.concurrencyData = concurrencyData;
        appState.stats.peakConcurrency = peakConcurrency;
        appState.stats.avgConcurrency = concurrencyData.length > 0 ? Math.round(totalConcurrency / concurrencyData.length) : 0;
        appState.stats.totalIntervals = concurrencyData.length;
        
        calculatePeakTimes(daysAboveThreshold);
        updateStatsUI();
        renderConcurrencyChart();
        renderPeakTable();
        renderIntervalsTable();
        
        el.btnExport.disabled = false;
        
        updateLoadingProgress(100);
        setTimeout(() => setLoading(false), 500);
        
        showStatusMessage(`‚úÖ Daily concurrency analysis complete - Peak: ${peakConcurrency} concurrent users on ${formatDateFromInterval(appState.stats.peakInterval)}`, 'success');
        
      } catch (error) {
        setLoading(false);
        showStatusMessage(`‚ùå Failed to analyse daily concurrency: ${error.message}`, 'error');
        console.error('Concurrency error:', error);
      }
    }

    // ==================== CALCULATE PEAK TIMES ====================
    function calculatePeakTimes(daysAboveThreshold) {
      if (appState.concurrencyData.length === 0) return;
      
      const peak = appState.concurrencyData.reduce((max, curr) => curr.concurrent > max.concurrent ? curr : max);
      appState.stats.peakInterval = peak.interval;
      appState.stats.peakConcurrency = peak.concurrent;
      
      el.peakTimeOverall.textContent = formatDateFromInterval(peak.interval);
      el.peakConcurrencyOverall.textContent = `${peak.concurrent} concurrent users`;
      
      el.peakDay.textContent = appState.stats.totalIntervals;
      el.peakDayConcurrency.textContent = 'days in range';
      
      el.peakHour.textContent = daysAboveThreshold || 0;
      el.peakHourConcurrency.textContent = 'days exceed alert';
    }

    // ==================== UI RENDERING ====================
    function updateStatsUI() {
      el.statPeakConcurrency.textContent = appState.stats.peakConcurrency;
      el.statAvgConcurrency.textContent = appState.stats.avgConcurrency;
      el.statTotalIntervals.textContent = appState.stats.totalIntervals;
      el.thresholdValue.textContent = appState.threshold;
    }

    function renderConcurrencyChart() {
      if (!el.concurrencyChart || !window.Chart) return;
      if (appState.chart) { appState.chart.destroy(); }
      if (appState.concurrencyData.length === 0) return;
      
      let displayData = appState.concurrencyData;
      if (displayData.length > 100) { 
        displayData = displayData.slice(-100); 
      }
      
      const labels = displayData.map(item => formatDateOnly(item.interval));
      const data = displayData.map(item => item.concurrent);
      const threshold = appState.threshold;
      
      appState.chart = new Chart(el.concurrencyChart, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            { 
              label: 'Daily Peak Concurrent Users', 
              data: data, 
              borderColor: '#63AB8F', 
              backgroundColor: 'rgba(99, 171, 143, 0.1)', 
              borderWidth: 2, 
              pointRadius: 4, 
              pointHoverRadius: 8, 
              pointBackgroundColor: '#63AB8F', 
              pointBorderColor: '#fff', 
              tension: 0.1, 
              fill: true 
            },
            { 
              label: 'Alert Threshold', 
              data: Array(data.length).fill(threshold), 
              borderColor: '#dc3545', 
              borderWidth: 2, 
              borderDash: [5, 5], 
              pointRadius: 0, 
              fill: false 
            }
          ]
        },
        options: {
          responsive: true, 
          maintainAspectRatio: false,
          interaction: { intersect: false, mode: 'index' },
          plugins: {
            tooltip: {
              callbacks: {
                afterBody: function(context) {
                  const idx = context[0].dataIndex;
                  const item = displayData[idx];
                  if (item.concurrent > threshold) { 
                    return '‚ö†Ô∏è Exceeds threshold!'; 
                  }
                  return '';
                }
              }
            }
          },
          scales: { 
            y: { 
              beginAtZero: true, 
              title: { display: true, text: 'Concurrent Users' } 
            } 
          }
        }
      });
    }

    function renderPeakTable() {
      const tbody = el.peakTableBody;
      tbody.innerHTML = '';
      const threshold = appState.threshold;
      const peakData = appState.concurrencyData.filter(item => item.concurrent > threshold).sort((a, b) => b.concurrent - a.concurrent);
      
      if (peakData.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;padding:48px;color:var(--text-light);">No days exceed the threshold of ${threshold} concurrent users.</td></tr>`;
        return;
      }
      
      const peak = appState.stats.peakConcurrency;
      peakData.forEach(item => {
        const row = document.createElement('tr');
        const percentage = Math.round((item.concurrent / peak) * 100);
        let statusClass = 'peak-badge', statusText = 'Peak Day';
        
        if (percentage >= 90) { 
          statusText = 'Critical Peak Day'; 
        } else if (percentage >= 70) { 
          statusText = 'High Usage Day'; 
          statusClass = 'high-badge'; 
        } else { 
          statusText = 'Above Threshold'; 
          statusClass = 'high-badge'; 
        }
        
        row.innerHTML = `<td style="font-weight:600;">${formatDateOnly(item.interval)}</td>
                         <td style="font-weight:700;color:${percentage >= 90 ? 'var(--danger)' : 'var(--warning)'};">${item.concurrent}</td>
                         <td>${percentage}%</td>
                         <td><span class="${statusClass}">${statusText}</span></td>`;
        tbody.appendChild(row);
      });
    }

    function renderIntervalsTable() {
      const tbody = el.intervalsTableBody;
      tbody.innerHTML = '';
      
      if (appState.concurrencyData.length === 0) {
        tbody.innerHTML = `<tr><td colspan="3" style="text-align:center;padding:48px;color:var(--text-light);">No data available. Run daily concurrency analysis first.</td></tr>`;
        return;
      }
      
      let data = [...appState.concurrencyData];
      const searchTerm = el.searchInterval?.value?.toLowerCase() || '';
      
      if (searchTerm) {
        data = data.filter(item => formatDateOnly(item.interval).toLowerCase().includes(searchTerm));
      }
      
      el.visibleIntervals.textContent = data.length;
      el.totalIntervals.textContent = appState.concurrencyData.length;
      
      data.forEach((item, idx) => {
        const prev = idx > 0 ? data[idx - 1].concurrent : item.concurrent;
        const change = item.concurrent - prev;
        const changeIcon = change > 0 ? '‚ñ≤' : change < 0 ? '‚ñº' : '‚óÜ';
        const changeColor = change > 0 ? 'var(--danger)' : change < 0 ? 'var(--success)' : 'var(--text-light)';
        
        const row = document.createElement('tr');
        row.innerHTML = `<td>${formatDateOnly(item.interval)}</td>
                         <td style="font-weight:600;color:${item.concurrent > appState.threshold ? 'var(--danger)' : 'inherit'};">${item.concurrent}</td>
                         <td style="color:${changeColor};">${changeIcon} ${change !== 0 ? Math.abs(change) : '0'}</td>`;
        tbody.appendChild(row);
      });
    }

    // ==================== EXPORT ====================
    function exportReport() {
      if (!appState.concurrencyData.length) { 
        showStatusMessage('No data to export', 'error'); 
        return; 
      }
      
      let csv = 'Genesys Cloud Daily Concurrency Report - London Region\n';
      csv += `Generated: ${new Date().toLocaleString()}\n`;
      csv += `Environment: London (euw2.pure.cloud)\n`;
      csv += `Period: ${el.dateFrom.value} to ${el.dateTo.value}\n`;
      csv += `Analysis Type: Daily Aggregation\n`;
      csv += `Alert Threshold: ${appState.threshold} concurrent users\n`;
      csv += `Total Users Analysed: ${appState.stats.totalUsers}\n`;
      csv += `Peak Daily Concurrency: ${appState.stats.peakConcurrency}\n`;
      csv += `Average Daily Concurrency: ${appState.stats.avgConcurrency}\n`;
      csv += `Total Days Analysed: ${appState.stats.totalIntervals}\n\n`;
      csv += 'PEAK DAYS (Exceeding Threshold)\n';
      csv += 'Date,Peak Concurrent Users,% of Peak Day,Status\n';
      
      const peakData = appState.concurrencyData.filter(item => item.concurrent > appState.threshold).sort((a, b) => b.concurrent - a.concurrent);
      peakData.forEach(item => {
        const percentage = Math.round((item.concurrent / appState.stats.peakConcurrency) * 100);
        csv += `${formatDateOnly(item.interval)},${item.concurrent},${percentage}%,Above Threshold\n`;
      });
      
      csv += '\nALL DAYS\n';
      csv += 'Date,Peak Concurrent Users\n';
      appState.concurrencyData.forEach(item => { 
        csv += `${formatDateOnly(item.interval)},${item.concurrent}\n`; 
      });
      
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const dateStr = new Date().toISOString().split('T')[0];
      a.href = url;
      a.download = `genesys_daily_concurrency_london_report_${dateStr}.csv`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      showStatusMessage('‚úÖ Daily report exported successfully', 'success');
    }

    function resetApplication() {
      if (confirm('Reset the application? This will clear all data but keep the connection.')) {
        appState.users = []; 
        appState.concurrencyData = [];
        appState.stats = { totalUsers: 0, peakConcurrency: 0, avgConcurrency: 0, totalIntervals: 0, peakInterval: null };
        
        el.statTotalUsers.textContent = '0'; 
        el.statPeakConcurrency.textContent = '0'; 
        el.statAvgConcurrency.textContent = '0'; 
        el.statTotalIntervals.textContent = '0';
        el.peakTimeOverall.textContent = '--/--/----'; 
        el.peakConcurrencyOverall.textContent = '0 concurrent users';
        el.peakDay.textContent = '0'; 
        el.peakDayConcurrency.textContent = 'days in range';
        el.peakHour.textContent = '0'; 
        el.peakHourConcurrency.textContent = 'days exceed alert';
        
        el.btnFetchConcurrency.disabled = true; 
        el.btnExport.disabled = true;
        
        if (appState.chart) { 
          appState.chart.destroy(); 
          appState.chart = null; 
        }
        
        renderPeakTable(); 
        renderIntervalsTable();
        showStatusMessage('üîÑ Application reset', 'info');
      }
    }

    // ==================== INITIALISATION ====================
    function initializeApp() {
      console.log("Initializing London daily app...");
      const last7Days = getLast7Days();
      if (el.dateFrom) el.dateFrom.value = last7Days.from;
      if (el.dateTo) el.dateTo.value = last7Days.to;
      updateDateRangeInfo();

      if (el.btnFetchUsers) { el.btnFetchUsers.addEventListener('click', fetchUsers); }
      if (el.btnFetchConcurrency) { el.btnFetchConcurrency.addEventListener('click', fetchConcurrency); }
      if (el.btnExport) { el.btnExport.addEventListener('click', exportReport); }
      if (el.btnReset) { el.btnReset.addEventListener('click', resetApplication); }
      if (el.btnManualAuth) { el.btnManualAuth.addEventListener('click', manualAuth); }

      if (el.thresholdConcurrency) {
        el.thresholdConcurrency.addEventListener('change', function() {
          appState.threshold = parseInt(this.value) || 20;
          localStorage.setItem(STORAGE_KEYS.THRESHOLD, appState.threshold);
          if (el.thresholdValue) el.thresholdValue.textContent = appState.threshold;
          if (appState.concurrencyData.length > 0) {
            renderConcurrencyChart();
            renderPeakTable();
          }
        });
      }

      if (el.searchInterval) { el.searchInterval.addEventListener('input', renderIntervalsTable); }
      if (el.dateFrom) {
        el.dateFrom.addEventListener('change', function() {
          localStorage.setItem(STORAGE_KEYS.DATE_FROM, el.dateFrom.value);
          updateDateRangeInfo();
        });
      }
      if (el.dateTo) {
        el.dateTo.addEventListener('change', function() {
          localStorage.setItem(STORAGE_KEYS.DATE_TO, el.dateTo.value);
          updateDateRangeInfo();
        });
      }

      // Load saved threshold
      const savedThreshold = localStorage.getItem(STORAGE_KEYS.THRESHOLD);
      if (savedThreshold) {
        appState.threshold = parseInt(savedThreshold);
        el.thresholdConcurrency.value = appState.threshold;
        el.thresholdValue.textContent = appState.threshold;
      }
    }

    // ==================== START ====================
    window.onload = function() {
      console.log("London region daily page loaded, initializing...");
      initAuth();
      initializeApp();
    };
  </script>
</body>
</html>
