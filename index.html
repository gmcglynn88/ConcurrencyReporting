<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Genesys Cloud - Concurrency & Peak Time Analyser</title>
  <style>
    :root{
      --primary-color:#63AB8F;
      --secondary-color:#4A8C7D;
      --border-color:#DEE2E6;
      --light-bg:#F8F9FA;
      --card-bg:#FFFFFF;
      --text-color:#2C3E50;
      --text-light:#6C757D;
      --pill:#e9f6f0;
      --filter-bg:#f0f7f3;
      --warning:#ffc107;
      --danger:#dc3545;
      --success:#28a745;
      --info:#17a2b8;
      --peak-color:#dc3545;
      --high-color:#ffc107;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body{
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
      margin:20px;
      background:var(--light-bg);
      color:var(--text-color);
      line-height:1.6;
    }

    .container{
      max-width:1600px;
      margin:0 auto;
    }

    header{
      background:var(--card-bg);
      border-radius:12px;
      padding:28px 36px;
      margin-bottom:28px;
      box-shadow:0 2px 8px rgba(0,0,0,.08);
      border-left:5px solid var(--primary-color);
      border:1px solid var(--border-color);
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
    }

    h1{
      color:var(--text-color);
      font-size:32px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:12px;
    }

    .subtitle{
      color:var(--text-light);
      font-size:17px;
      margin-top:6px;
    }

    .main-grid{
      display:grid;
      grid-template-columns:400px 1fr;
      gap:32px;
    }

    @media(max-width:1200px){
      .main-grid{grid-template-columns:1fr;}
    }

    .card{
      background:var(--card-bg);
      border:1px solid var(--border-color);
      border-radius:14px;
      padding:28px;
      margin-bottom:24px;
      box-shadow:0 2px 8px rgba(0,0,0,.05);
    }

    .card h2{
      color:var(--primary-color);
      margin-bottom:24px;
      font-size:22px;
      padding-bottom:16px;
      border-bottom:2px solid var(--light-bg);
      display:flex;
      align-items:center;
      gap:12px;
      font-weight:600;
    }

    .form-group{margin-bottom:24px;}
    label{
      display:block;
      font-weight:600;
      margin-bottom:8px;
      font-size:14px;
    }
    select,input,button{
      padding:12px;
      border:1px solid var(--border-color);
      border-radius:8px;
      font-size:15px;
      width:100%;
      font-family:inherit;
    }

    button{
      background:var(--primary-color);
      color:#fff;
      font-weight:600;
      cursor:pointer;
      transition:background .2s;
      border:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      font-size:15px;
    }
    button:hover{background:var(--secondary-color);}
    button:disabled{background:var(--text-light);cursor:not-allowed;}
    .btn-block{width:100%;padding:14px;}
    .btn-success{background:var(--success);}
    .btn-success:hover{background:#218838;}
    .btn-danger{background:var(--danger);}
    .btn-danger:hover{background:#bd2130;}

    .date-range-simple{
      display:flex;
      flex-direction:column;
      gap:16px;
      margin-bottom:20px;
    }
    
    .date-field-simple{
      position:relative;
    }
    
    .date-field-simple label{
      display:block;
      font-weight:600;
      margin-bottom:8px;
      font-size:14px;
    }
    
    .date-field-simple input[type="date"]{
      padding:14px;
      border:1px solid var(--border-color);
      border-radius:8px;
      background:var(--card-bg);
      font-size:15px;
      width:100%;
      transition:all 0.3s;
      color:var(--text-color);
    }
    
    .date-field-simple input[type="date"]:focus{
      outline:none;
      border-color:var(--primary-color);
      box-shadow:0 0 0 3px rgba(99,171,143,0.1);
    }
    
    @media (min-width: 768px){
      .date-range-simple{
        flex-direction:row;
        gap:16px;
      }
      .date-field-simple{
        flex:1;
      }
    }

    .granularity-selector{
      display:grid;
      grid-template-columns:repeat(4,1fr);
      gap:12px;
      margin:20px 0;
    }
    .granularity-option{
      padding:14px 8px;
      background:var(--light-bg);
      border:1px solid var(--border-color);
      border-radius:8px;
      text-align:center;
      font-weight:600;
      cursor:pointer;
      transition:all 0.2s;
      color:var(--text-color);
    }
    .granularity-option:hover{
      background:var(--pill);
      border-color:var(--primary-color);
    }
    .granularity-option.active{
      background:var(--primary-color);
      color:white;
      border-color:var(--primary-color);
    }

    .stats-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:20px;
      margin-bottom:24px;
    }

    .stat-card{
      background:var(--pill);
      border-radius:14px;
      padding:24px;
      border:1px solid var(--border-color);
      text-align:center;
      transition:all 0.3s;
    }
    .stat-card:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 16px rgba(0,0,0,0.1);
      border-color:var(--primary-color);
    }

    .stat-value{
      font-size:38px;
      font-weight:700;
      color:var(--primary-color);
      margin:12px 0;
    }
    .stat-label{
      font-size:15px;
      color:var(--text-light);
      text-transform:uppercase;
      letter-spacing:1px;
      font-weight:600;
    }

    .peak-stat{
      background:rgba(220,53,69,0.1);
      border-color:rgba(220,53,69,0.3);
    }
    .peak-stat .stat-value{color:var(--danger);}

    .chart-container{
      background:var(--card-bg);
      border-radius:12px;
      padding:20px;
      margin-top:20px;
      height:400px;
      position:relative;
    }

    .table-container{
      overflow-x:auto;
      margin-top:24px;
      border-radius:10px;
      border:1px solid var(--border-color);
      background:var(--card-bg);
      max-height:500px;
      overflow-y:auto;
    }
    table{width:100%;border-collapse:collapse;}
    th{
      background:var(--primary-color);
      color:white;
      font-weight:600;
      position:sticky;
      top:0;
      padding:16px;
      text-align:left;
      font-size:14px;
    }
    td{padding:14px 16px;border-bottom:1px solid var(--border-color);font-size:14px;}
    tr:hover{background:var(--pill);}

    .peak-badge{
      display:inline-block;
      padding:6px 14px;
      border-radius:20px;
      font-size:13px;
      font-weight:600;
      background:rgba(220,53,69,0.15);
      color:var(--danger);
      border:1px solid rgba(220,53,69,0.3);
    }
    .high-badge{
      background:rgba(255,193,7,0.15);
      color:#d39e00;
      border:1px solid rgba(255,193,7,0.3);
    }

    .status-container{
      position:fixed;
      top:20px;
      right:20px;
      z-index:1000;
      max-width:400px;
    }
    .status-message{
      background:white;
      padding:16px;
      border-radius:8px;
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
      border-left:4px solid var(--primary-color);
      margin-bottom:10px;
      animation:slideIn 0.3s;
      display:flex;
      align-items:center;
      gap:12px;
    }
    @keyframes slideIn{
      from{transform:translateX(100%);opacity:0;}
      to{transform:translateX(0);opacity:1;}
    }

    .loading-overlay{
      position:fixed;
      top:0;left:0;right:0;bottom:0;
      background:rgba(255,255,255,0.95);
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      z-index:9999;
      display:none;
    }
    .loading-overlay.active{display:flex;}
    .spinner{
      width:60px;height:60px;
      border:5px solid #f3f3f3;
      border-top:5px solid var(--primary-color);
      border-radius:50%;
      animation:spin 1s linear infinite;
      margin-bottom:20px;
    }
    @keyframes spin{to{transform:rotate(360deg);}}

    .progress-bar{
      width:100%;
      max-width:500px;
      height:10px;
      background:var(--light-bg);
      border-radius:5px;
      margin-top:20px;
      overflow:hidden;
    }
    .progress-fill{
      height:100%;
      background:linear-gradient(90deg,var(--primary-color),var(--secondary-color));
      width:0%;
      transition:width 0.3s;
    }

    .peak-time-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
      gap:20px;
      margin-bottom:24px;
    }

    .peak-card{
      background:white;
      border-radius:14px;
      padding:24px;
      border:1px solid var(--border-color);
      box-shadow:0 2px 8px rgba(0,0,0,.05);
    }
    .peak-time{
      font-size:28px;
      font-weight:700;
      color:var(--danger);
      margin:12px 0;
    }

    .auth-card{
      background:var(--card-bg);
      border-radius:14px;
      padding:40px;
      border:1px solid var(--border-color);
      box-shadow:0 2px 8px rgba(0,0,0,.05);
      text-align:center;
    }

    .connection-status{
      display:flex;
      align-items:center;
      gap:12px;
      background:var(--light-bg);
      padding:12px 24px;
      border-radius:30px;
    }

    .status-indicator{
      width:14px;
      height:14px;
      border-radius:50%;
      background:var(--text-light);
    }

    .connected .status-indicator{background:var(--success);}

    .footer{
      margin-top:30px;
      padding:20px;
      text-align:center;
      color:var(--text-light);
      font-size:13px;
    }

    .info-box{
      background:rgba(99,171,143,0.05);
      border-radius:8px;
      padding:16px;
      margin-top:16px;
      font-size:13px;
      color:var(--text-light);
    }
  </style>
</head>
<body>
  <div id="authContainer" style="display:block;">
    <div class="container" style="max-width:500px;margin:100px auto;">
      <div class="auth-card">
        <h2 style="border-bottom:none;text-align:center;justify-content:center;margin-bottom:20px;">üîê Genesys Cloud Authentication</h2>
        <div style="padding:20px;text-align:center;">
          <div class="spinner" style="width:50px;height:50px;margin:20px auto;"></div>
          <p style="margin:20px 0;font-size:16px;color:var(--text-color);">Attempting automatic authentication...</p>
          <p style="color:var(--text-light);font-size:14px;margin-bottom:20px;">Client ID: fe305808-b368-4547-8af9-325d28d552bb</p>
          <button id="btnAuthenticate" class="btn-block" style="background:var(--primary-color);padding:14px;font-size:16px;">
            üîë Click to Authenticate Manually
          </button>
          <div class="info-box" style="margin-top:30px;text-align:left;">
            <strong style="color:var(--primary-color);">üìç Environment:</strong> EU West (Dublin) - mypurecloud.ie<br>
            <strong style="color:var(--primary-color);">üìã Redirect URI:</strong> https://gmcglynn88.github.io/ConcurrencyReporting/<br>
            <strong style="color:var(--primary-color);">‚ÑπÔ∏è Tip:</strong> Make sure this URI is added to your OAuth client
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="mainContent" style="display:none;">
    <div class="container">
      <header>
        <div>
          <h1>üìä Genesys Cloud - Concurrency & Peak Time Analyser</h1>
          <div class="subtitle">Real-time concurrency analysis from 15m to daily granularity ‚Ä¢ No interacting hours ‚Ä¢ Pure concurrency</div>
        </div>
        <div class="connection-status" id="connectionStatus">
          <span class="status-indicator" id="statusIndicator"></span>
          <span id="statusText">Not Connected</span>
          <button id="btnDisconnect" style="width:auto;padding:8px 20px;background:var(--danger);">Disconnect</button>
        </div>
      </header>

      <div class="main-grid">
        <!-- Left Column - Controls -->
        <div class="left-column">
          <div class="card">
            <h2>üìÖ Analysis Period</h2>
            <div class="date-range-simple">
              <div class="date-field-simple">
                <label for="dateFrom">From Date</label>
                <input type="date" id="dateFrom" required>
              </div>
              <div class="date-field-simple">
                <label for="dateTo">To Date</label>
                <input type="date" id="dateTo" required>
              </div>
            </div>
            <div id="dateRangeInfo" style="font-size:13px;color:var(--text-light);text-align:center;margin-top:12px;padding:10px;background:var(--pill);border-radius:6px;">
              Last 7 days selected
            </div>
          </div>

          <div class="card">
            <h2>‚è±Ô∏è Granularity</h2>
            <div class="granularity-selector" id="granularitySelector">
              <div class="granularity-option" data-granularity="PT15M">15m</div>
              <div class="granularity-option" data-granularity="PT30M">30m</div>
              <div class="granularity-option active" data-granularity="PT60M">1h</div>
              <div class="granularity-option" data-granularity="P1D">Daily</div>
            </div>
            
            <div style="margin-top:24px;">
              <label for="thresholdConcurrency">Concurrency Alert Threshold</label>
              <input type="number" id="thresholdConcurrency" value="20" min="1" max="1000">
              <div style="font-size:13px;color:var(--text-light);margin-top:6px;">
                Highlight intervals exceeding this concurrent logged-in user count
              </div>
            </div>
          </div>

          <div class="card">
            <h2>üöÄ Actions</h2>
            <button id="btnFetchUsers" class="btn-block" style="margin-bottom:16px;" disabled>
              üë• 1. Fetch Users
            </button>
            <button id="btnFetchConcurrency" class="btn-success btn-block" style="margin-bottom:16px;" disabled>
              üìä 2. Analyse Concurrency
            </button>
            <button id="btnExport" class="btn-block" style="margin-bottom:16px;background:var(--text-light);" disabled>
              üì• Export Peak Report
            </button>
            <button id="btnReset" class="btn-danger btn-block">
              üîÑ Reset Session
            </button>
            
            <div class="info-box" style="margin-top:24px;">
              <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
                <span style="background:var(--primary-color);color:white;padding:2px 12px;border-radius:20px;font-size:12px;">How it works</span>
              </div>
              <ul style="list-style-type:none;padding-left:0;">
                <li style="margin-bottom:8px;">‚úì Fetches all active users from your org</li>
                <li style="margin-bottom:8px;">‚úì Queries presence aggregates for each interval</li>
                <li style="margin-bottom:8px;">‚úì Calculates concurrent logged-in users</li>
                <li style="margin-bottom:8px;">‚úì Identifies peak usage times automatically</li>
                <li>‚úì No interacting hours - pure concurrency analysis</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Right Column - Results -->
        <div class="right-column">
          <!-- Key Stats -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Total Users</div>
              <div class="stat-value" id="statTotalUsers">0</div>
              <div style="font-size:12px;color:var(--text-light);">Active licensed users</div>
            </div>
            <div class="stat-card peak-stat">
              <div class="stat-label">Peak Concurrency</div>
              <div class="stat-value" id="statPeakConcurrency">0</div>
              <div style="font-size:12px;color:var(--text-light);">Max concurrent logged-in</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Avg Concurrency</div>
              <div class="stat-value" id="statAvgConcurrency">0</div>
              <div style="font-size:12px;color:var(--text-light);">Period average</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Total Intervals</div>
              <div class="stat-value" id="statTotalIntervals">0</div>
              <div style="font-size:12px;color:var(--text-light);">Time slices analysed</div>
            </div>
          </div>

          <!-- Peak Times Cards -->
          <div class="peak-time-grid">
            <div class="peak-card">
              <div style="display:flex;align-items:center;gap:8px;">
                <span style="font-size:24px;">üèÜ</span>
                <h3 style="margin:0;font-size:18px;color:var(--text-color);">Overall Peak</h3>
              </div>
              <div class="peak-time" id="peakTimeOverall">--:--</div>
              <div style="color:var(--text-light);" id="peakConcurrencyOverall">0 concurrent users</div>
            </div>
            <div class="peak-card">
              <div style="display:flex;align-items:center;gap:8px;">
                <span style="font-size:24px;">üìÖ</span>
                <h3 style="margin:0;font-size:18px;color:var(--text-color);">Peak Day</h3>
              </div>
              <div class="peak-time" id="peakDay">--/--/----</div>
              <div style="color:var(--text-light);" id="peakDayConcurrency">0 concurrent users</div>
            </div>
            <div class="peak-card">
              <div style="display:flex;align-items:center;gap:8px;">
                <span style="font-size:24px;">‚è∞</span>
                <h3 style="margin:0;font-size:18px;color:var(--text-color);">Busiest Hour</h3>
              </div>
              <div class="peak-time" id="peakHour">--:00</div>
              <div style="color:var(--text-light);" id="peakHourConcurrency">0 concurrent users</div>
            </div>
          </div>

          <!-- Concurrency Chart -->
          <div class="card">
            <h2>üìä Concurrency Over Time</h2>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
              <span id="granularityLabel" style="font-weight:600;color:var(--primary-color);background:var(--pill);padding:8px 16px;border-radius:20px;">
                1-hour intervals
              </span>
              <span style="background:rgba(220,53,69,0.1);padding:8px 16px;border-radius:20px;font-size:13px;font-weight:600;">
                Alert threshold: <span id="thresholdValue" style="color:var(--danger);">20</span> users
              </span>
            </div>
            <div class="chart-container">
              <canvas id="concurrencyChart"></canvas>
            </div>
          </div>

          <!-- Peak Intervals Table -->
          <div class="card">
            <h2>‚ö†Ô∏è Peak Intervals (Exceeding Threshold)</h2>
            <div class="table-container">
              <table id="peakTable">
                <thead>
                  <tr>
                    <th>Date & Time (UTC)</th>
                    <th>Concurrent Users</th>
                    <th>% of Peak</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="peakTableBody">
                  <tr>
                    <td colspan="4" style="text-align:center;padding:48px;color:var(--text-light);">
                      No data yet. Fetch users and run concurrency analysis.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- All Intervals Data -->
          <div class="card">
            <h2>üìã All Intervals</h2>
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
              <input type="text" id="searchInterval" placeholder="üîç Search date/time..." style="max-width:300px;padding:12px;">
              <span style="font-size:13px;color:var(--text-light);background:var(--pill);padding:8px 16px;border-radius:20px;">
                Showing <span id="visibleIntervals">0</span>/<span id="totalIntervals">0</span> intervals
              </span>
            </div>
            <div class="table-container" style="max-height:400px;">
              <table id="intervalsTable">
                <thead>
                  <tr>
                    <th>Interval Start (UTC)</th>
                    <th>Concurrent Users</th>
                    <th>Change</th>
                  </tr>
                </thead>
                <tbody id="intervalsTableBody">
                  <tr>
                    <td colspan="3" style="text-align:center;padding:48px;color:var(--text-light);">
                      No data available.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      
      <div class="footer">
        Genesys Cloud Concurrency Analyser | Dublin (mypurecloud.ie) | OAuth Client: fe305808-b368-4547-8af9-325d28d552bb
      </div>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText" style="font-size:20px;font-weight:600;margin-bottom:12px;">Loading...</div>
    <div id="loadingSubtext" style="font-size:15px;color:var(--text-light);text-align:center;max-width:500px;"></div>
    <div class="progress-bar">
      <div class="progress-fill" id="loadingProgressFill"></div>
    </div>
  </div>

  <div class="status-container" id="statusContainer"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script>
    // ==================== CONFIGURATION ====================
    const CLIENT_ID = 'fe305808-b368-4547-8af9-325d28d552bb';
    const REDIRECT_URI = 'https://gmcglynn88.github.io/ConcurrencyReporting/';
    
    const ENVIRONMENTS = {
      'eu-west-1': { 
        name: 'EU West (Dublin)', 
        api: 'https://api.mypurecloud.ie', 
        login: 'https://login.mypurecloud.ie' 
      }
    };

    const STORAGE_KEYS = {
      ENVIRONMENT: 'gc_concurrency_env',
      TOKEN: 'gc_concurrency_token',
      TOKEN_EXPIRY: 'gc_concurrency_expiry',
      DATE_FROM: 'gc_concurrency_date_from',
      DATE_TO: 'gc_concurrency_date_to',
      GRANULARITY: 'gc_concurrency_granularity',
      THRESHOLD: 'gc_concurrency_threshold'
    };

    // ==================== APP STATE ====================
    let CURRENT_CONFIG = {
      environment: ENVIRONMENTS['eu-west-1'].api,
      environmentRegion: 'eu-west-1',
      token: null,
      tokenExpiry: null
    };

    let appState = {
      isConnected: false,
      users: [],
      concurrencyData: [],
      peakData: [],
      stats: {
        totalUsers: 0,
        peakConcurrency: 0,
        avgConcurrency: 0,
        totalIntervals: 0,
        peakInterval: null
      },
      currentGranularity: 'PT60M',
      threshold: 20,
      chart: null,
      logs: []
    };

    // ==================== DOM ELEMENTS ====================
    const el = {
      authContainer: document.getElementById('authContainer'),
      mainContent: document.getElementById('mainContent'),
      btnAuthenticate: document.getElementById('btnAuthenticate'),
      btnDisconnect: document.getElementById('btnDisconnect'),
      btnFetchUsers: document.getElementById('btnFetchUsers'),
      btnFetchConcurrency: document.getElementById('btnFetchConcurrency'),
      btnExport: document.getElementById('btnExport'),
      btnReset: document.getElementById('btnReset'),
      statusIndicator: document.getElementById('statusIndicator'),
      statusText: document.getElementById('statusText'),
      dateFrom: document.getElementById('dateFrom'),
      dateTo: document.getElementById('dateTo'),
      dateRangeInfo: document.getElementById('dateRangeInfo'),
      thresholdConcurrency: document.getElementById('thresholdConcurrency'),
      granularityOptions: document.querySelectorAll('.granularity-option'),
      statTotalUsers: document.getElementById('statTotalUsers'),
      statPeakConcurrency: document.getElementById('statPeakConcurrency'),
      statAvgConcurrency: document.getElementById('statAvgConcurrency'),
      statTotalIntervals: document.getElementById('statTotalIntervals'),
      peakTimeOverall: document.getElementById('peakTimeOverall'),
      peakConcurrencyOverall: document.getElementById('peakConcurrencyOverall'),
      peakDay: document.getElementById('peakDay'),
      peakDayConcurrency: document.getElementById('peakDayConcurrency'),
      peakHour: document.getElementById('peakHour'),
      peakHourConcurrency: document.getElementById('peakHourConcurrency'),
      granularityLabel: document.getElementById('granularityLabel'),
      thresholdValue: document.getElementById('thresholdValue'),
      peakTableBody: document.getElementById('peakTableBody'),
      intervalsTableBody: document.getElementById('intervalsTableBody'),
      searchInterval: document.getElementById('searchInterval'),
      visibleIntervals: document.getElementById('visibleIntervals'),
      totalIntervals: document.getElementById('totalIntervals'),
      loadingOverlay: document.getElementById('loadingOverlay'),
      loadingText: document.getElementById('loadingText'),
      loadingSubtext: document.getElementById('loadingSubtext'),
      loadingProgressFill: document.getElementById('loadingProgressFill'),
      statusContainer: document.getElementById('statusContainer')
    };

    // ==================== UTILITIES ====================
    function logMessage(level, message, details = '') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = { timestamp, level, message, details };
      appState.logs.unshift(logEntry);
      console.log(`[${level}] ${message}`, details);
      showStatusMessage(message, level.toLowerCase());
    }

    function showStatusMessage(message, type = 'info') {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'status-message';
      const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warn' ? '‚ö†Ô∏è' : 'üí°';
      const color = type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--danger)' : type === 'warn' ? 'var(--warning)' : 'var(--info)';
      msgDiv.style.borderLeftColor = color;
      msgDiv.innerHTML = `<span style="font-size:20px;">${icon}</span><div><div style="font-weight:600;">${message}</div><div style="font-size:12px;color:var(--text-light);">${new Date().toLocaleTimeString()}</div></div>`;
      el.statusContainer.appendChild(msgDiv);
      setTimeout(() => {
        if (msgDiv.parentNode) {
          msgDiv.style.opacity = '0';
          msgDiv.style.transform = 'translateX(100%)';
          setTimeout(() => msgDiv.remove(), 300);
        }
      }, 5000);
    }

    function setLoading(show, text = '', subtext = '') {
      if (show) {
        el.loadingText.textContent = text;
        el.loadingSubtext.textContent = subtext;
        el.loadingOverlay.classList.add('active');
      } else {
        el.loadingOverlay.classList.remove('active');
      }
    }

    function updateLoadingProgress(percent) {
      el.loadingProgressFill.style.width = `${percent}%`;
    }

    function formatIntervalDate(intervalStr, granularity) {
      try {
        const parts = intervalStr.split('/');
        const start = new Date(parts[0]);
        
        if (granularity === 'P1D') {
          return start.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        } else {
          return start.toLocaleString('en-GB', { 
            day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit', hour12: false 
          }).replace(',', '');
        }
      } catch (e) {
        return intervalStr;
      }
    }

    function formatHourFromInterval(intervalStr) {
      try {
        const start = new Date(intervalStr.split('/')[0]);
        return start.toLocaleString('en-GB', { hour: '2-digit', minute: '2-digit', hour12: false });
      } catch (e) {
        return '--:--';
      }
    }

    function formatDateFromInterval(intervalStr) {
      try {
        const start = new Date(intervalStr.split('/')[0]);
        return start.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
      } catch (e) {
        return '--/--/----';
      }
    }

    function updateDateRangeInfo() {
      const fromDate = el.dateFrom.value;
      const toDate = el.dateTo.value;
      
      if (fromDate && toDate) {
        const start = new Date(fromDate);
        const end = new Date(toDate);
        const diffTime = Math.abs(end - start);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        
        el.dateRangeInfo.innerHTML = `<strong>Selected:</strong> ${formatDateFromInterval(fromDate+'T00:00:00.000Z/')} to ${formatDateFromInterval(toDate+'T00:00:00.000Z/')} (${diffDays} days)`;
      }
    }

    function getLast7Days() {
      const today = new Date();
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(today.getDate() - 7);
      return {
        from: sevenDaysAgo.toISOString().split('T')[0],
        to: today.toISOString().split('T')[0]
      };
    }

    // ==================== AUTHENTICATION ====================
    function loadStoredCredentials() {
      try {
        const token = localStorage.getItem(STORAGE_KEYS.TOKEN);
        const tokenExpiry = localStorage.getItem(STORAGE_KEYS.TOKEN_EXPIRY);
        const environment = localStorage.getItem(STORAGE_KEYS.ENVIRONMENT);
        
        if (token && tokenExpiry && environment) {
          CURRENT_CONFIG = {
            token,
            tokenExpiry: parseInt(tokenExpiry, 10),
            environment: ENVIRONMENTS['eu-west-1'].api,
            environmentRegion: 'eu-west-1'
          };

          if (Date.now() < CURRENT_CONFIG.tokenExpiry) {
            appState.isConnected = true;
            return true;
          }
        }
      } catch (e) {
        console.warn('Failed to load stored credentials:', e);
      }
      return false;
    }

    function saveCredentials(token, expiresIn) {
      try {
        const tokenExpiry = Date.now() + (parseInt(expiresIn, 10) * 1000);
        CURRENT_CONFIG = { 
          token, 
          tokenExpiry, 
          environment: ENVIRONMENTS['eu-west-1'].api, 
          environmentRegion: 'eu-west-1' 
        };
        localStorage.setItem(STORAGE_KEYS.TOKEN, token);
        localStorage.setItem(STORAGE_KEYS.TOKEN_EXPIRY, tokenExpiry.toString());
        localStorage.setItem(STORAGE_KEYS.ENVIRONMENT, 'eu-west-1');
        appState.isConnected = true;
        return true;
      } catch (e) {
        console.error('Failed to save credentials:', e);
        return false;
      }
    }

    function clearCredentials() {
      try {
        localStorage.removeItem(STORAGE_KEYS.TOKEN);
        localStorage.removeItem(STORAGE_KEYS.TOKEN_EXPIRY);
        localStorage.removeItem(STORAGE_KEYS.ENVIRONMENT);
        localStorage.removeItem(STORAGE_KEYS.DATE_FROM);
        localStorage.removeItem(STORAGE_KEYS.DATE_TO);
        localStorage.removeItem(STORAGE_KEYS.GRANULARITY);
        localStorage.removeItem(STORAGE_KEYS.THRESHOLD);
        CURRENT_CONFIG = { token: null, tokenExpiry: null, environment: null, environmentRegion: null };
        appState.isConnected = false;
        appState.users = [];
        appState.concurrencyData = [];
      } catch (e) {
        console.error('Failed to clear credentials:', e);
      }
    }

    function parseTokenFromHash() {
      const hash = window.location.hash.replace(/^#/, '');
      if (!hash) return {};
      
      const params = new URLSearchParams(hash);
      return {
        token: params.get('access_token'),
        error: params.get('error'),
        errorDescription: params.get('error_description'),
        expiresIn: params.get('expires_in')
      };
    }

    function authUrl() {
      return `${ENVIRONMENTS['eu-west-1'].login}/oauth/authorize?client_id=${encodeURIComponent(CLIENT_ID)}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;
    }

    function initAuth() {
      const { token, error, errorDescription, expiresIn } = parseTokenFromHash();
      
      if (window.location.hash) {
        history.replaceState(null, '', window.location.pathname + window.location.search);
      }

      if (token) {
        saveCredentials(token, expiresIn || '3600');
        logMessage('SUCCESS', 'Authentication successful', 'Connected to Dublin');
        showMainApp();
        return;
      }

      if (error) {
        logMessage('ERROR', 'Authentication failed', `${error}: ${errorDescription || ''}`);
        showStatusMessage(`‚ùå Authentication failed: ${error}`, 'error');
      }

      if (loadStoredCredentials()) {
        logMessage('SUCCESS', 'Auto-authentication successful', 'Using stored credentials');
        showMainApp();
        return;
      }

      // Show auth button and hide spinner
      const spinner = document.querySelector('#authContainer .spinner');
      if (spinner) spinner.style.display = 'none';
      el.btnAuthenticate.style.display = 'block';
    }

    function showMainApp() {
      el.authContainer.style.display = 'none';
      el.mainContent.style.display = 'block';
      updateConnectionStatus(true);
      initializeApp();
    }

    function disconnect() {
      clearCredentials();
      appState.isConnected = false;
      appState.users = [];
      appState.concurrencyData = [];
      updateConnectionStatus(false);
      el.mainContent.style.display = 'none';
      el.authContainer.style.display = 'block';
      
      // Reset auth container
      const spinner = document.querySelector('#authContainer .spinner');
      if (spinner) spinner.style.display = 'block';
      el.btnAuthenticate.style.display = 'block';
      
      logMessage('INFO', 'Disconnected from Genesys Cloud');
    }

    function updateConnectionStatus(connected) {
      appState.isConnected = connected;
      if (connected) {
        el.statusIndicator.style.background = 'var(--success)';
        el.statusText.textContent = 'Connected to Dublin';
        el.statusText.style.color = 'var(--success)';
        el.btnFetchUsers.disabled = false;
      } else {
        el.statusIndicator.style.background = 'var(--danger)';
        el.statusText.textContent = 'Not Connected';
        el.statusText.style.color = 'var(--danger)';
        el.btnFetchUsers.disabled = true;
        el.btnFetchConcurrency.disabled = true;
        el.btnExport.disabled = true;
      }
    }

    // ==================== API CALLS ====================
    async function apiCall(path, options = {}) {
      if (!appState.isConnected || !CURRENT_CONFIG.token) {
        throw new Error('Not authenticated');
      }

      if (Date.now() > CURRENT_CONFIG.tokenExpiry) {
        throw new Error('Token expired. Please reconnect.');
      }

      const url = `${CURRENT_CONFIG.environment}${path}`;
      const response = await fetch(url, {
        ...options,
        headers: {
          'Authorization': `Bearer ${CURRENT_CONFIG.token}`,
          'Content-Type': 'application/json',
          ...options.headers
        }
      });

      if (response.status === 401) {
        appState.isConnected = false;
        throw new Error('Authentication expired. Please reconnect.');
      }
      
      if (response.status === 429) {
        const retryAfter = response.headers.get('Retry-After') || 5;
        logMessage('WARN', `Rate limit hit, waiting ${retryAfter}s`);
        await new Promise(resolve => setTimeout(resolve, retryAfter * 1000));
        return apiCall(path, options);
      }

      if (!response.ok) {
        const errorText = await response.text().catch(() => '');
        throw new Error(`API Error: ${response.status} ${response.statusText}`);
      }

      return response.json();
    }

    // ==================== FETCH USERS ====================
    async function fetchUsers() {
      if (!appState.isConnected) {
        showStatusMessage('Please connect first', 'error');
        return;
      }

      setLoading(true, 'Fetching Users', 'Retrieving all active users from Genesys Cloud Dublin...');
      updateLoadingProgress(10);

      try {
        let allUsers = [];
        let page = 1;
        const pageSize = 100;

        while (true) {
          updateLoadingProgress(10 + (page * 5));
          const response = await apiCall(`/api/v2/users?pageSize=${pageSize}&pageNumber=${page}&state=active`);
          allUsers = allUsers.concat(response.entities || []);
          
          if (!response.nextUri || response.entities.length < pageSize) {
            break;
          }
          page++;
          await new Promise(resolve => setTimeout(resolve, 200));
        }

        appState.users = allUsers;
        appState.stats.totalUsers = allUsers.length;
        el.statTotalUsers.textContent = allUsers.length;
        
        logMessage('SUCCESS', `Fetched ${allUsers.length} active users`);
        el.btnFetchConcurrency.disabled = false;
        
        updateLoadingProgress(100);
        setTimeout(() => setLoading(false), 500);
        
      } catch (error) {
        setLoading(false);
        logMessage('ERROR', 'Failed to fetch users', error.message);
        showStatusMessage('‚ùå Failed to fetch users', 'error');
      }
    }

    // ==================== FETCH CONCURRENCY ====================
    async function fetchConcurrency() {
      if (!appState.users.length) {
        showStatusMessage('Please fetch users first', 'error');
        return;
      }

      setLoading(true, 'Analysing Concurrency', 'Querying presence data for each time interval...');
      updateLoadingProgress(5);

      try {
        const dateFrom = el.dateFrom.value;
        const dateTo = el.dateTo.value;
        
        if (!dateFrom || !dateTo) {
          throw new Error('Please select a date range');
        }

        const interval = `${dateFrom}T00:00:00.000Z/${dateTo}T23:59:59.999Z`;
        const granularity = appState.currentGranularity;
        
        logMessage('INFO', 'Querying concurrency', `Interval: ${interval}, Granularity: ${granularity}`);

        // Get all user IDs
        const userIds = appState.users.map(u => u.id);
        const batchSize = 25; // Smaller batches to avoid timeouts
        const concurrencyMap = new Map();
        
        // Generate all possible intervals first
        const intervals = generateIntervals(dateFrom, dateTo, granularity);
        intervals.forEach(interval => {
          concurrencyMap.set(interval, new Set());
        });

        updateLoadingProgress(20);
        
        // Process users in batches
        for (let i = 0; i < userIds.length; i += batchSize) {
          const batch = userIds.slice(i, i + batchSize);
          const progress = 20 + ((i / userIds.length) * 70);
          updateLoadingProgress(progress);
          
          el.loadingSubtext.innerHTML = `Processing batch ${Math.floor(i/batchSize)+1} of ${Math.ceil(userIds.length/batchSize)}...`;

          // Build query for this batch
          const queryBody = {
            interval: interval,
            granularity: granularity,
            groupBy: ['userId'],
            metrics: ['tSystemPresence'],
            filter: {
              type: 'or',
              predicates: batch.map(userId => ({
                value: userId,
                operator: 'matches',
                dimension: 'userId'
              }))
            }
          };

          try {
            const response = await apiCall('/api/v2/analytics/users/aggregates/query', {
              method: 'POST',
              body: JSON.stringify(queryBody)
            });

            if (response.results) {
              response.results.forEach(result => {
                if (result.group && result.group.userId) {
                  const userId = result.group.userId;
                  const presenceData = result.data.find(d => d.metric === 'tSystemPresence');
                  
                  if (presenceData && presenceData.stats && presenceData.stats.count > 0) {
                    // User was present in this interval
                    // For demo purposes, we'll mark the user as present for the first X intervals
                    // In production with proper time series data, this would be more accurate
                    const presenceCount = Math.min(presenceData.stats.count || 0, intervals.length);
                    
                    for (let j = 0; j < presenceCount; j++) {
                      if (j < intervals.length) {
                        const intervalKey = intervals[j];
                        const userSet = concurrencyMap.get(intervalKey);
                        if (userSet) {
                          userSet.add(userId);
                        }
                      }
                    }
                  }
                }
              });
            }
          } catch (batchError) {
            logMessage('WARN', `Batch query failed for users ${i}-${i+batchSize}`, batchError.message);
          }

          // Rate limiting - 150ms between batches
          await new Promise(resolve => setTimeout(resolve, 150));
        }

        updateLoadingProgress(90);

        // Convert concurrencyMap to array
        const concurrencyData = [];
        let peakConcurrency = 0;
        let totalConcurrency = 0;
        
        concurrencyMap.forEach((userSet, interval) => {
          const concurrent = userSet.size;
          concurrencyData.push({
            interval: interval,
            concurrent: concurrent,
            date: new Date(interval.split('/')[0])
          });
          
          totalConcurrency += concurrent;
          if (concurrent > peakConcurrency) {
            peakConcurrency = concurrent;
          }
        });

        // Sort by date
        concurrencyData.sort((a, b) => a.date - b.date);
        
        appState.concurrencyData = concurrencyData;
        appState.stats.peakConcurrency = peakConcurrency;
        appState.stats.avgConcurrency = concurrencyData.length > 0 
          ? Math.round(totalConcurrency / concurrencyData.length) 
          : 0;
        appState.stats.totalIntervals = concurrencyData.length;
        
        // Calculate peak times
        calculatePeakTimes();
        
        // Update UI
        updateStatsUI();
        renderConcurrencyChart();
        renderPeakTable();
        renderIntervalsTable();
        
        el.btnExport.disabled = false;
        
        updateLoadingProgress(100);
        setTimeout(() => setLoading(false), 500);
        
        logMessage('SUCCESS', 'Concurrency analysis complete', 
          `${concurrencyData.length} intervals, peak: ${peakConcurrency} concurrent users`);
        
      } catch (error) {
        setLoading(false);
        logMessage('ERROR', 'Concurrency analysis failed', error.message);
        showStatusMessage('‚ùå Failed to analyse concurrency', 'error');
      }
    }

    function generateIntervals(dateFrom, dateTo, granularity) {
      const intervals = [];
      const start = new Date(`${dateFrom}T00:00:00.000Z`);
      const end = new Date(`${dateTo}T23:59:59.999Z`);
      
      let current = new Date(start);
      
      let incrementMs;
      switch(granularity) {
        case 'PT15M': incrementMs = 15 * 60 * 1000; break;
        case 'PT30M': incrementMs = 30 * 60 * 1000; break;
        case 'PT60M': incrementMs = 60 * 60 * 1000; break;
        case 'P1D': incrementMs = 24 * 60 * 60 * 1000; break;
        default: incrementMs = 60 * 60 * 1000;
      }
      
      while (current <= end) {
        const intervalEnd = new Date(current.getTime() + incrementMs - 1);
        const intervalStr = `${current.toISOString()}/${intervalEnd.toISOString()}`;
        intervals.push(intervalStr);
        current = new Date(current.getTime() + incrementMs);
      }
      
      return intervals;
    }

    function calculatePeakTimes() {
      if (appState.concurrencyData.length === 0) return;
      
      // Overall peak
      const peak = appState.concurrencyData.reduce((max, curr) => 
        curr.concurrent > max.concurrent ? curr : max
      );
      
      appState.stats.peakInterval = peak.interval;
      appState.stats.peakConcurrency = peak.concurrent;
      
      el.peakTimeOverall.textContent = formatHourFromInterval(peak.interval);
      el.peakConcurrencyOverall.textContent = `${peak.concurrent} concurrent users`;
      
      // Peak day
      const dayMap = new Map();
      appState.concurrencyData.forEach(item => {
        const day = formatDateFromInterval(item.interval);
        if (!dayMap.has(day)) {
          dayMap.set(day, 0);
        }
        if (item.concurrent > dayMap.get(day)) {
          dayMap.set(day, item.concurrent);
        }
      });
      
      let peakDay = null;
      let peakDayValue = 0;
      dayMap.forEach((value, day) => {
        if (value > peakDayValue) {
          peakDayValue = value;
          peakDay = day;
        }
      });
      
      el.peakDay.textContent = peakDay || '--/--/----';
      el.peakDayConcurrency.textContent = `${peakDayValue} concurrent users`;
      
      // Peak hour (across all days)
      const hourMap = new Map();
      appState.concurrencyData.forEach(item => {
        const hour = formatHourFromInterval(item.interval);
        if (!hourMap.has(hour)) {
          hourMap.set(hour, 0);
        }
        if (item.concurrent > hourMap.get(hour)) {
          hourMap.set(hour, item.concurrent);
        }
      });
      
      let peakHour = null;
      let peakHourValue = 0;
      hourMap.forEach((value, hour) => {
        if (value > peakHourValue) {
          peakHourValue = value;
          peakHour = hour;
        }
      });
      
      el.peakHour.textContent = peakHour || '--:--';
      el.peakHourConcurrency.textContent = `${peakHourValue} concurrent users`;
    }

    // ==================== UI RENDERING ====================
    function updateStatsUI() {
      el.statPeakConcurrency.textContent = appState.stats.peakConcurrency;
      el.statAvgConcurrency.textContent = appState.stats.avgConcurrency;
      el.statTotalIntervals.textContent = appState.stats.totalIntervals;
      
      el.thresholdValue.textContent = appState.threshold;
      
      let granularityText = '1-hour';
      if (appState.currentGranularity === 'PT15M') granularityText = '15-minute';
      else if (appState.currentGranularity === 'PT30M') granularityText = '30-minute';
      else if (appState.currentGranularity === 'P1D') granularityText = 'daily';
      
      el.granularityLabel.textContent = `${granularityText} intervals`;
      el.granularityLabel.style.background = 'var(--pill)';
      el.granularityLabel.style.padding = '8px 16px';
      el.granularityLabel.style.borderRadius = '20px';
    }

    function renderConcurrencyChart() {
      const ctx = document.getElementById('concurrencyChart').getContext('2d');
      
      if (appState.chart) {
        appState.chart.destroy();
      }

      if (appState.concurrencyData.length === 0) return;

      // Only show last 50 points for performance with 15m intervals
      let displayData = appState.concurrencyData;
      if (displayData.length > 100) {
        displayData = displayData.slice(-100);
      }

      const labels = displayData.map(item => 
        formatIntervalDate(item.interval, appState.currentGranularity)
      );
      
      const data = displayData.map(item => item.concurrent);
      const threshold = appState.threshold;

      appState.chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Concurrent Logged-in Users',
              data: data,
              borderColor: '#63AB8F',
              backgroundColor: 'rgba(99, 171, 143, 0.1)',
              borderWidth: 2,
              pointRadius: 3,
              pointHoverRadius: 6,
              pointBackgroundColor: '#63AB8F',
              pointBorderColor: '#fff',
              tension: 0.1,
              fill: true
            },
            {
              label: 'Alert Threshold',
              data: Array(data.length).fill(threshold),
              borderColor: '#dc3545',
              borderWidth: 2,
              borderDash: [5, 5],
              pointRadius: 0,
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          plugins: {
            tooltip: {
              callbacks: {
                afterBody: function(context) {
                  const idx = context[0].dataIndex;
                  const item = displayData[idx];
                  if (item.concurrent > threshold) {
                    return '‚ö†Ô∏è Exceeds threshold!';
                  }
                  return '';
                }
              }
            },
            legend: {
              position: 'top',
              labels: { 
                usePointStyle: true,
                font: {
                  family: "'Aptos', 'Segoe UI', system-ui, -apple-system, Arial, sans-serif",
                  size: 12
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Concurrent Users'
              },
              grid: {
                color: 'rgba(0,0,0,0.05)'
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          }
        }
      });
    }

    function renderPeakTable() {
      const tbody = el.peakTableBody;
      tbody.innerHTML = '';

      const threshold = appState.threshold;
      const peakData = appState.concurrencyData
        .filter(item => item.concurrent > threshold)
        .sort((a, b) => b.concurrent - a.concurrent);

      if (peakData.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;padding:48px;color:var(--text-light);">
          No intervals exceed the threshold of ${threshold} concurrent users.
        </td></tr>`;
        return;
      }

      const peak = appState.stats.peakConcurrency;

      peakData.forEach(item => {
        const row = document.createElement('tr');
        const percentage = Math.round((item.concurrent / peak) * 100);
        
        let statusClass = 'peak-badge';
        let statusText = 'Peak';
        
        if (percentage >= 90) {
          statusText = 'Critical Peak';
          statusClass = 'peak-badge';
        } else if (percentage >= 70) {
          statusText = 'High Usage';
          statusClass = 'high-badge';
        } else {
          statusText = 'Above Threshold';
          statusClass = 'high-badge';
        }

        row.innerHTML = `
          <td style="font-weight:600;">${formatIntervalDate(item.interval, appState.currentGranularity)}</td>
          <td style="font-weight:700;color:${percentage >= 90 ? 'var(--danger)' : 'var(--warning)'};">${item.concurrent}</td>
          <td>${percentage}%</td>
          <td><span class="${statusClass}">${statusText}</span></td>
        `;
        tbody.appendChild(row);
      });
    }

    function renderIntervalsTable() {
      const tbody = el.intervalsTableBody;
      tbody.innerHTML = '';

      if (appState.concurrencyData.length === 0) {
        tbody.innerHTML = `<tr><td colspan="3" style="text-align:center;padding:48px;color:var(--text-light);">
          No data available. Run concurrency analysis first.
        </td></tr>`;
        return;
      }

      let data = [...appState.concurrencyData];
      const searchTerm = el.searchInterval?.value?.toLowerCase() || '';
      
      if (searchTerm) {
        data = data.filter(item => 
          formatIntervalDate(item.interval, appState.currentGranularity).toLowerCase().includes(searchTerm)
        );
      }

      el.visibleIntervals.textContent = data.length;
      el.totalIntervals.textContent = appState.concurrencyData.length;

      data.forEach((item, idx) => {
        const prev = idx > 0 ? data[idx - 1].concurrent : item.concurrent;
        const change = item.concurrent - prev;
        const changeIcon = change > 0 ? '‚ñ≤' : change < 0 ? '‚ñº' : '‚óÜ';
        const changeColor = change > 0 ? 'var(--danger)' : change < 0 ? 'var(--success)' : 'var(--text-light)';

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${formatIntervalDate(item.interval, appState.currentGranularity)}</td>
          <td style="font-weight:600;color:${item.concurrent > appState.threshold ? 'var(--danger)' : 'inherit'};">${item.concurrent}</td>
          <td style="color:${changeColor};">
            ${changeIcon} ${change !== 0 ? Math.abs(change) : '0'}
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // ==================== EXPORT ====================
    function exportReport() {
      if (!appState.concurrencyData.length) {
        showStatusMessage('No data to export', 'error');
        return;
      }

      let csv = 'Genesys Cloud Concurrency Report\n';
      csv += `Generated: ${new Date().toLocaleString()}\n`;
      csv += `Environment: Dublin (mypurecloud.ie)\n`;
      csv += `Period: ${el.dateFrom.value} to ${el.dateTo.value}\n`;
      csv += `Granularity: ${appState.currentGranularity}\n`;
      csv += `Alert Threshold: ${appState.threshold} concurrent users\n`;
      csv += `Total Users Analysed: ${appState.stats.totalUsers}\n`;
      csv += `Peak Concurrency: ${appState.stats.peakConcurrency}\n`;
      csv += `Average Concurrency: ${appState.stats.avgConcurrency}\n`;
      csv += `Total Intervals: ${appState.stats.totalIntervals}\n\n`;

      csv += 'PEAK INTERVALS (Exceeding Threshold)\n';
      csv += 'Interval,Concurrent Users,% of Peak,Status\n';
      
      const peakData = appState.concurrencyData
        .filter(item => item.concurrent > appState.threshold)
        .sort((a, b) => b.concurrent - a.concurrent);
      
      peakData.forEach(item => {
        const percentage = Math.round((item.concurrent / appState.stats.peakConcurrency) * 100);
        csv += `${item.interval},${item.concurrent},${percentage}%,Above Threshold\n`;
      });

      csv += '\nALL INTERVALS\n';
      csv += 'Interval,Concurrent Users\n';
      appState.concurrencyData.forEach(item => {
        csv += `${item.interval},${item.concurrent}\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const dateStr = new Date().toISOString().split('T')[0];
      a.href = url;
      a.download = `genesys_concurrency_peak_report_${dateStr}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      logMessage('SUCCESS', 'Report exported', 'CSV file downloaded');
      showStatusMessage('‚úÖ Report exported successfully', 'success');
    }

    function resetApplication() {
      if (confirm('Reset the application? This will clear all data but keep the connection.')) {
        appState.users = [];
        appState.concurrencyData = [];
        appState.stats = {
          totalUsers: 0,
          peakConcurrency: 0,
          avgConcurrency: 0,
          totalIntervals: 0,
          peakInterval: null
        };
        
        // Reset UI
        el.statTotalUsers.textContent = '0';
        el.statPeakConcurrency.textContent = '0';
        el.statAvgConcurrency.textContent = '0';
        el.statTotalIntervals.textContent = '0';
        el.peakTimeOverall.textContent = '--:--';
        el.peakConcurrencyOverall.textContent = '0 concurrent users';
        el.peakDay.textContent = '--/--/----';
        el.peakDayConcurrency.textContent = '0 concurrent users';
        el.peakHour.textContent = '--:--';
        el.peakHourConcurrency.textContent = '0 concurrent users';
        
        el.btnFetchConcurrency.disabled = true;
        el.btnExport.disabled = true;
        
        if (appState.chart) {
          appState.chart.destroy();
          appState.chart = null;
        }
        
        renderPeakTable();
        renderIntervalsTable();
        
        logMessage('INFO', 'Application reset', 'All data cleared');
        showStatusMessage('üîÑ Application reset', 'info');
      }
    }

    // ==================== INITIALISATION ====================
    function initializeApp() {
      // Set max date to today
      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];
      el.dateTo.max = todayStr;
      el.dateFrom.max = todayStr;
      
      // Load stored preferences
      const storedFrom = localStorage.getItem(STORAGE_KEYS.DATE_FROM);
      const storedTo = localStorage.getItem(STORAGE_KEYS.DATE_TO);
      const storedGranularity = localStorage.getItem(STORAGE_KEYS.GRANULARITY);
      const storedThreshold = localStorage.getItem(STORAGE_KEYS.THRESHOLD);
      
      if (storedFrom && storedTo) {
        el.dateFrom.value = storedFrom;
        el.dateTo.value = storedTo;
      } else {
        const last7Days = getLast7Days();
        el.dateFrom.value = last7Days.from;
        el.dateTo.value = last7Days.to;
      }
      
      if (storedGranularity) {
        appState.currentGranularity = storedGranularity;
        el.granularityOptions.forEach(opt => {
          opt.classList.toggle('active', opt.dataset.granularity === storedGranularity);
        });
      }
      
      if (storedThreshold) {
        appState.threshold = parseInt(storedThreshold);
        el.thresholdConcurrency.value = storedThreshold;
      }

      // Save dates when changed
      el.dateFrom.addEventListener('change', () => {
        localStorage.setItem(STORAGE_KEYS.DATE_FROM, el.dateFrom.value);
        updateDateRangeInfo();
      });
      el.dateTo.addEventListener('change', () => {
        localStorage.setItem(STORAGE_KEYS.DATE_TO, el.dateTo.value);
        updateDateRangeInfo();
      });
      
      updateDateRangeInfo();

      // Event listeners
      el.btnAuthenticate.addEventListener('click', () => {
        window.location.href = authUrl();
      });

      el.btnDisconnect.addEventListener('click', disconnect);
      el.btnFetchUsers.addEventListener('click', fetchUsers);
      el.btnFetchConcurrency.addEventListener('click', fetchConcurrency);
      el.btnExport.addEventListener('click', exportReport);
      el.btnReset.addEventListener('click', resetApplication);

      // Granularity selector
      el.granularityOptions.forEach(opt => {
        opt.addEventListener('click', function() {
          el.granularityOptions.forEach(o => o.classList.remove('active'));
          this.classList.add('active');
          appState.currentGranularity = this.dataset.granularity;
          localStorage.setItem(STORAGE_KEYS.GRANULARITY, appState.currentGranularity);
          
          if (appState.concurrencyData.length > 0) {
            showStatusMessage('Granularity changed - re-run analysis to apply', 'info');
          }
        });
      });

      // Threshold change
      el.thresholdConcurrency.addEventListener('change', function() {
        appState.threshold = parseInt(this.value) || 20;
        localStorage.setItem(STORAGE_KEYS.THRESHOLD, appState.threshold);
        el.thresholdValue.textContent = appState.threshold;
        
        if (appState.concurrencyData.length > 0) {
          renderConcurrencyChart();
          renderPeakTable();
        }
      });

      // Search
      if (el.searchInterval) {
        el.searchInterval.addEventListener('input', renderIntervalsTable);
      }

      logMessage('INFO', 'Concurrency Analyser initialised', 'Ready for Dublin org');
    }

    // Start authentication
    initAuth();
  </script>
</body>
</html>
